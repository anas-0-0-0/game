<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ ŸÑŸàÿ≠ÿ© ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑŸÖÿπŸÑŸÖ - ŸÖÿ≥ÿßÿ®ŸÇÿ© ÿßŸÑÿπŸÑŸàŸÖ</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="styles-common.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, var(--navis-primary), var(--navis-dark-blue));
            background-attachment: fixed;
            color: #fff;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        .top-bar {
            position: sticky;
            top: 0;
            z-index: 50;
            margin-bottom: 18px;
            padding: 14px 14px;
            border-radius: var(--radius-lg);
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.14);
            backdrop-filter: blur(14px);
        }
        .top-bar-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }
        .top-bar-main {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .pill {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.14);
            font-weight: 700;
            color: rgba(255,255,255,0.95);
        }
        .pill .value {
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }
        .btn-compact {
            padding: 10px 14px;
            border-radius: 14px;
        }

        .kpis {
            display: grid;
            grid-template-columns: repeat(4, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 14px;
        }
        .kpi {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.14);
            border-radius: 16px;
            padding: 14px 14px;
            backdrop-filter: blur(10px);
        }
        .kpi-label {
            font-size: 0.95em;
            color: rgba(255,255,255,0.85);
            font-weight: 700;
        }
        .kpi-value {
            font-size: 1.55em;
            font-weight: 900;
            margin-top: 6px;
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .kpi-sub {
            margin-top: 6px;
            font-size: 0.9em;
            color: rgba(255,255,255,0.8);
        }
        
        /* ÿ™ÿ£ÿ´Ÿäÿ±ÿßÿ™ ÿπŸÑŸÖŸäÿ© ŸÅŸä ÿßŸÑÿÆŸÑŸÅŸäÿ© */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(74, 44, 114, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(60, 179, 113, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 20%, rgba(255, 165, 0, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        body::after {
            content: '‚öõÔ∏è';
            position: fixed;
            font-size: 300px;
            opacity: 0.03;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--spacing-mobile);
        }
        @media (min-width: 769px) { .container { padding: var(--spacing-tablet); } }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.15), rgba(60, 179, 113, 0.1));
            border-radius: var(--radius-lg);
            backdrop-filter: blur(20px);
            border: 2px solid var(--navis-primary);
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, var(--navis-primary), var(--navis-secondary), var(--navis-orange));
            box-shadow: 0 0 20px rgba(74, 44, 114, 0.5);
        }
        
        .header::after {
            content: 'üî¨';
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 3em;
            opacity: 0.1;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .header h1 {
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(60, 179, 113, 0.5);
            position: relative;
            z-index: 1;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.15), rgba(60, 179, 113, 0.1));
            border: 2px solid var(--navis-primary);
            border-radius: var(--radius-md);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-glow);
        }

        .room-code {
            font-size: 1.3em;
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .timer {
            font-size: 2em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--science-red), var(--science-red-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            padding: 10px 20px;
            background-color: rgba(231, 76, 60, 0.15);
            border-radius: var(--radius-md);
            border: 2px solid var(--science-red);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .question-monitor {
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.15), rgba(60, 179, 113, 0.1));
            border-radius: var(--radius-lg);
            padding: 30px;
            border: 2px solid var(--navis-primary);
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow-glow);
            position: relative;
            overflow: hidden;
        }

        .question-summary {
            margin-top: 18px;
            padding: 16px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(0,0,0,0.18);
        }
        .question-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .correct-pill {
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.14);
            background: linear-gradient(135deg, rgba(60, 179, 113, 0.22), rgba(47, 141, 90, 0.16));
            color: rgba(255,255,255,0.95);
            font-weight: 800;
        }
        .dist {
            display: grid;
            gap: 10px;
        }
        .dist-row {
            display: grid;
            grid-template-columns: 34px 1fr 56px;
            gap: 10px;
            align-items: center;
        }
        .dist-letter {
            font-weight: 900;
            color: rgba(255,255,255,0.9);
            text-align: center;
        }
        .dist-bar {
            height: 10px;
            border-radius: 999px;
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.10);
            overflow: hidden;
        }
        .dist-fill {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--navis-primary), var(--navis-secondary));
            transition: width 0.25s ease;
        }
        .dist-pct {
            font-weight: 800;
            color: rgba(255,255,255,0.85);
            text-align: left;
            font-variant-numeric: tabular-nums;
        }
        
        .question-monitor::before {
            content: 'üî¨';
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 4em;
            opacity: 0.1;
            animation: float 3s ease-in-out infinite;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: linear-gradient(135deg, var(--navis-primary), var(--navis-dark-blue));
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 700;
            box-shadow: 0 3px 10px rgba(74, 44, 114, 0.4);
        }

        .question-category {
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.2), rgba(60, 179, 113, 0.15));
            color: var(--navis-primary);
            padding: 8px 18px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--navis-primary);
            font-weight: 600;
        }

        .question-text {
            font-size: 1.4em;
            margin-bottom: 25px;
            line-height: 1.8;
            color: #fff;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        .options-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-preview {
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.1), rgba(60, 179, 113, 0.05));
            border: 2px solid var(--navis-primary);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin-bottom: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .option-preview:hover {
            border-color: var(--navis-secondary);
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.2), rgba(60, 179, 113, 0.15));
        }

        .option-preview.correct-answer {
            background: linear-gradient(135deg, rgba(60, 179, 113, 0.25), rgba(47, 141, 90, 0.2));
            border-color: var(--navis-secondary);
            color: white;
            font-weight: 700;
            box-shadow: 0 5px 20px rgba(60, 179, 113, 0.4);
        }

        .option-preview.correct-answer::after {
            content: ' ‚úì';
            color: var(--navis-secondary);
            font-weight: bold;
            font-size: 1.2em;
        }

        .option-preview.correct {
            background: linear-gradient(135deg, rgba(60, 179, 113, 0.3), rgba(47, 141, 90, 0.25));
            border-color: var(--navis-secondary);
            box-shadow: 0 0 20px rgba(60, 179, 113, 0.5);
        }

        .teams-monitor {
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.15), rgba(60, 179, 113, 0.1));
            border-radius: var(--radius-lg);
            padding: 30px;
            border: 2px solid var(--navis-primary);
            backdrop-filter: blur(15px);
            box-shadow: var(--shadow-glow);
        }

        .teams-monitor h2 {
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-light-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 1.8em;
        }
        
        .teams-monitor h2::before {
            content: 'üë•';
            font-size: 1.2em;
        }

        .team-answer-card {
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.1), rgba(60, 179, 113, 0.05));
            border: 2px solid var(--navis-primary);
            border-radius: var(--radius-md);
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .team-answer-card.leader {
            border-color: var(--navis-secondary);
            box-shadow: 0 10px 25px rgba(60, 179, 113, 0.22);
        }
        .team-answer-card.last {
            opacity: 0.82;
        }

        .team-row-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: start;
        }
        .meta {
            text-align: left;
            min-width: 150px;
        }
        .meta-line {
            font-size: 0.9em;
            color: rgba(255,255,255,0.82);
            font-weight: 700;
        }
        .meta-line strong {
            color: rgba(255,255,255,0.95);
        }
        
        .team-answer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(74, 44, 114, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .team-answer-card:hover::before {
            left: 100%;
        }

        .team-answer-card.answered {
            background: linear-gradient(135deg, rgba(74, 44, 114, 0.2), rgba(60, 179, 113, 0.15));
            border-color: var(--navis-primary);
            box-shadow: 0 5px 20px rgba(74, 44, 114, 0.3);
        }

        .team-answer-card.correct {
            background: linear-gradient(135deg, rgba(60, 179, 113, 0.25), rgba(47, 141, 90, 0.2));
            border-color: var(--navis-secondary);
            box-shadow: 0 5px 20px rgba(60, 179, 113, 0.4);
        }

        .team-answer-card.wrong {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.2), rgba(192, 57, 43, 0.15));
            border-color: var(--science-red);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.3);
        }

        .team-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .team-name {
            font-weight: bold;
            color: #fff;
        }

        .team-score {
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-dark-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.3em;
        }

        .answer-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }

        .status-waiting {
            color: var(--navis-orange);
            font-weight: 600;
        }

        .status-answered {
            background: linear-gradient(135deg, var(--navis-primary), var(--navis-dark-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
        }

        .status-correct {
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-dark-green));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .status-wrong {
            color: var(--science-red);
            font-weight: 700;
        }

        .selected-option {
            background: rgba(173, 216, 230, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            margin-top: 5px;
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--navis-primary), var(--navis-dark-blue));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-dark-green));
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--science-red), var(--science-red-dark));
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @media (max-width: 768px) {
            .top-bar-row { grid-template-columns: 1fr; }
            .kpis { grid-template-columns: repeat(2, minmax(140px, 1fr)); }
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .options-preview {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ÿ¥ÿπÿßÿ± ŸÜÿßŸÅÿ≥ ŸàŸàÿ≤ÿßÿ±ÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÖ -->
    <div class="logos-header">
        <div class="logo-container">
            <img src="ŸÜÿßŸÅÿ≥.png" alt="ÿ¥ÿπÿßÿ± ŸÜÿßŸÅÿ≥" class="logo-img">
            <div>
                <h3 class="logo-title">ŸÖÿ®ÿßÿØÿ±ÿ© ŸÜÿßŸÅÿ≥</h3>
                <p class="logo-subtitle">National Olympiad for Innovation & Science</p>
            </div>
        </div>
        <div class="logo-container">
            <div style="text-align: left;">
                <h3 class="logo-title">Ÿàÿ≤ÿßÿ±ÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÖ</h3>
                <p class="logo-subtitle">Ministry of Education</p>
            </div>
            <img src="Ÿàÿ≤ÿßÿ±Ÿá ÿßŸÑÿ™ÿπŸÑŸäŸÖ.png" alt="ÿ¥ÿπÿßÿ± Ÿàÿ≤ÿßÿ±ÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÖ" class="logo-img">
        </div>
    </div>

    <div class="container">
        <div class="top-bar">
            <div class="top-bar-row">
                <div class="top-bar-main">
                    <button class="btn btn-primary btn-compact" onclick="window.location.href='teacher.html'" style="background: rgba(255, 255, 255, 0.1);">
                        <i class="fas fa-arrow-right"></i> ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑŸÖÿπŸÑŸÖ
                    </button>
                    <div class="pill">
                        <span>ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©</span>
                        <span class="value" id="room-code-display">----</span>
                        <button class="btn btn-primary btn-compact" id="copy-room-code" type="button" style="background: rgba(255, 255, 255, 0.1);">
                            <i class="far fa-copy"></i>
                        </button>
                    </div>
                    <div class="pill">
                        <span>ÿßŸÑÿ≥ÿ§ÿßŸÑ</span>
                        <span class="value" id="top-question">1</span>
                    </div>
                    <div class="pill">
                        <span>ÿßŸÑŸÖÿ§ŸÇŸëÿ™</span>
                        <span class="value" id="timer">30</span>
                    </div>
                </div>
                <div style="text-align:left; color: rgba(255,255,255,0.85); font-weight:700;">
                    ŸÑŸàÿ≠ÿ© ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑŸÖÿπŸÑŸÖ
                </div>
            </div>

            <div class="kpis">
                <div class="kpi">
                    <div class="kpi-label">ÿßŸÑŸÅÿ±ŸÇ ÿßŸÑŸÖÿ™ÿµŸÑÿ©</div>
                    <div class="kpi-value" id="kpi-connected">0</div>
                    <div class="kpi-sub" id="kpi-connected-sub">ŸÅÿ±ŸÇ</div>
                </div>
                <div class="kpi">
                    <div class="kpi-label">ÿ¨ÿßŸàÿ®Ÿàÿß ÿßŸÑÿ≥ÿ§ÿßŸÑ</div>
                    <div class="kpi-value" id="kpi-answered">0</div>
                    <div class="kpi-sub" id="kpi-answered-sub">ŸÖŸÜ 0</div>
                </div>
                <div class="kpi">
                    <div class="kpi-label">ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿµÿ≠Ÿäÿ≠ÿ©</div>
                    <div class="kpi-value" id="kpi-correct">0</div>
                    <div class="kpi-sub" id="kpi-correct-sub">Ÿáÿ∞ÿß ÿßŸÑÿ≥ÿ§ÿßŸÑ</div>
                </div>
                <div class="kpi">
                    <div class="kpi-label">ÿßŸÑÿ£ÿ≥ÿ±ÿπ</div>
                    <div class="kpi-value" id="kpi-fastest">‚Äî</div>
                    <div class="kpi-sub" id="kpi-fastest-sub">‚Äî</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- ŸÇÿ≥ŸÖ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑÿ≥ÿ§ÿßŸÑ -->
            <div class="question-monitor">
                <div class="question-header">
                    <span class="question-number" id="question-number">ÿßŸÑÿ≥ÿ§ÿßŸÑ 1</span>
                    <span class="question-category" id="question-category">ÿπŸÑŸàŸÖ</span>
                </div>
                <div class="question-text" id="question-text">
                    ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ≥ÿ§ÿßŸÑ...
                </div>
                <div class="options-preview" id="options-preview">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ŸáŸÜÿß -->
                </div>

                <div class="question-summary" id="question-summary">
                    <div class="question-summary-header">
                        <div style="font-weight: 900; color: rgba(255,255,255,0.92);">ŸÖŸÑÿÆÿµ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≠ÿßŸÑŸä</div>
                        <div class="correct-pill" id="correct-answer-pill">ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿµÿ≠Ÿäÿ≠: ‚Äî</div>
                    </div>
                    <div class="dist" id="answer-distribution">
                        <div class="dist-row">
                            <div class="dist-letter">A</div>
                            <div class="dist-bar"><div class="dist-fill" id="dist-a"></div></div>
                            <div class="dist-pct" id="dist-a-pct">0%</div>
                        </div>
                        <div class="dist-row">
                            <div class="dist-letter">B</div>
                            <div class="dist-bar"><div class="dist-fill" id="dist-b"></div></div>
                            <div class="dist-pct" id="dist-b-pct">0%</div>
                        </div>
                        <div class="dist-row">
                            <div class="dist-letter">C</div>
                            <div class="dist-bar"><div class="dist-fill" id="dist-c"></div></div>
                            <div class="dist-pct" id="dist-c-pct">0%</div>
                        </div>
                        <div class="dist-row">
                            <div class="dist-letter">D</div>
                            <div class="dist-bar"><div class="dist-fill" id="dist-d"></div></div>
                            <div class="dist-pct" id="dist-d-pct">0%</div>
                        </div>
                    </div>
                </div>
                <div class="game-controls">
                    <button class="btn btn-primary" id="start-game-btn">
                        <i class="fas fa-play"></i> ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©
                    </button>
                    <button class="btn btn-primary" id="next-question-btn" disabled>
                        <i class="fas fa-arrow-right"></i> ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä
                    </button>
                    <button class="btn btn-success" id="show-answer-btn" disabled>
                        <i class="fas fa-eye"></i> ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©
                    </button>
                    <button class="btn btn-danger" id="end-game-btn">
                        <i class="fas fa-stop"></i> ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ©
                    </button>
                </div>
            </div>

            <!-- ŸÇÿ≥ŸÖ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑŸÅÿ±ŸÇ -->
            <div class="teams-monitor">
                <h2><i class="fas fa-users"></i> ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿ∑ŸÑÿßÿ®</h2>
                <div id="teams-monitor-container">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿπÿ±ÿ∂ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÅÿ±ŸÇ ŸáŸÜÿß -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-sync.js"></script>
    <script>
        function syncGameStateToFirebase(forceServerTimestamp) {
            var roomCode = (localStorage.getItem('currentRoom') || localStorage.getItem('roomCode') || '').trim();
            if (typeof FirebaseSync === 'undefined' || !FirebaseSync.isEnabled() || !roomCode) {
                if (!roomCode) console.warn('[ŸÖÿ±ÿßŸÇÿ®] ŸÑÿß ŸäŸàÿ¨ÿØ ŸÉŸàÿØ ÿ∫ÿ±ŸÅÿ© ‚Äî ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿØÿÆŸàŸÑ ŸÖŸÜ ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿπŸÑŸÖ ÿ£ŸàŸÑÿßŸã');
                return;
            }
            var qIndex = parseInt(localStorage.getItem('currentQuestionIndex'), 10);
            var cIndex = parseInt(localStorage.getItem('correctAnswerIndex'), 10);
            var state = {
                gameStarted: localStorage.getItem('gameStarted') === 'true',
                gameInProgress: localStorage.getItem('gameInProgress') === 'true',
                showCorrectAnswer: localStorage.getItem('showCorrectAnswer') === 'true'
            };
            if (forceServerTimestamp === true) {
                try {
                    if (typeof firebase !== 'undefined' && firebase.database && firebase.database.ServerValue && firebase.database.ServerValue.TIMESTAMP) {
                        state.questionStartTime = firebase.database.ServerValue.TIMESTAMP;
                    }
                } catch (e) {}
            }
            if (!isNaN(qIndex)) state.currentQuestionIndex = qIndex;
            if (!isNaN(cIndex)) state.correctAnswerIndex = cIndex;
            var questionsRaw = localStorage.getItem('currentQuestions');
            if (questionsRaw) {
                try {
                    var q = JSON.parse(questionsRaw);
                    if (Array.isArray(q) && q.length) state.currentQuestions = q;
                } catch (e) {}
            }
            var teamsRaw = localStorage.getItem('gameTeams');
            if (teamsRaw) {
                try {
                    var t = JSON.parse(teamsRaw);
                    if (Array.isArray(t) && t.length) state.gameTeams = t;
                } catch (e) {}
            }
            FirebaseSync.setGameStateOnServer(roomCode, state).then(function(ok) {
                if (ok) console.log('[Firebase] ÿ™ŸÖ ŸÖÿ≤ÿßŸÖŸÜÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©');
            });
        }
        // ÿ≠ÿßŸÑÿ© ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©
        const monitorState = {
            currentQuestion: 0,
            questions: [],
            teams: [],
            connectedTeamIds: [],
            answers: [],
            timer: 30,
            timerInterval: null,
            timerTimeout: null,
            answerMonitorInterval: null,
            answerShownForCurrentQuestion: false,
            gameActive: false,
            serverTimeOffset: 0,
            serverOffsetReady: false
        };

        function serverNow() {
            return Date.now() + (Number(monitorState.serverTimeOffset) || 0);
        }

        function getResultsHistory() {
            try {
                var raw = localStorage.getItem('gameResultsHistory');
                if (!raw) return [];
                var parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        }

        function saveResultsSession(teamsSnapshot) {
            try {
                var roomCode = localStorage.getItem('currentRoom') || '';
                var session = {
                    id: 'session_' + Date.now(),
                    createdAt: new Date().toISOString(),
                    roomCode: roomCode,
                    teams: teamsSnapshot
                };
                var history = getResultsHistory();
                history.unshift(session);
                if (history.length > 50) history = history.slice(0, 50);
                localStorage.setItem('gameResultsHistory', JSON.stringify(history));
                localStorage.setItem('lastResultsSessionId', session.id);

                if (typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled && FirebaseSync.isEnabled() && roomCode) {
                    if (FirebaseSync.saveResultsSessionOnServer) {
                        FirebaseSync.saveResultsSessionOnServer(roomCode, session).then(function(ok) {
                            if (ok) console.log('[Firebase] ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ±');
                        });
                    }
                }
            } catch (e) {}
        }

        // ÿπŸÜÿßÿµÿ± Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        const elements = {
            roomCodeDisplay: document.getElementById('room-code-display'),
            timer: document.getElementById('timer'), // ÿ∫Ÿäÿ± ŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸÑŸÖÿπŸÑŸÖ (Ÿäÿπÿ±ÿ∂ "ŸÖÿ±ÿßŸÇÿ®" ŸÅŸÇÿ∑)
            topQuestion: document.getElementById('top-question'),
            questionNumber: document.getElementById('question-number'),
            questionCategory: document.getElementById('question-category'),
            questionText: document.getElementById('question-text'),
            optionsPreview: document.getElementById('options-preview'),
            optionsContainer: document.getElementById('options-preview'), // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ options-preview ŸÉÿ®ÿØŸäŸÑ
            teamsMonitorContainer: document.getElementById('teams-monitor-container'),
            startGameBtn: document.getElementById('start-game-btn'),
            nextQuestionBtn: document.getElementById('next-question-btn'),
            showAnswerBtn: document.getElementById('show-answer-btn'),
            endGameBtn: document.getElementById('end-game-btn'),
            copyRoomCodeBtn: document.getElementById('copy-room-code'),
            kpiConnected: document.getElementById('kpi-connected'),
            kpiAnswered: document.getElementById('kpi-answered'),
            kpiCorrect: document.getElementById('kpi-correct'),
            kpiFastest: document.getElementById('kpi-fastest'),
            kpiAnsweredSub: document.getElementById('kpi-answered-sub'),
            kpiFastestSub: document.getElementById('kpi-fastest-sub'),
            correctAnswerPill: document.getElementById('correct-answer-pill'),
            distA: document.getElementById('dist-a'),
            distB: document.getElementById('dist-b'),
            distC: document.getElementById('dist-c'),
            distD: document.getElementById('dist-d'),
            distAPct: document.getElementById('dist-a-pct'),
            distBPct: document.getElementById('dist-b-pct'),
            distCPct: document.getElementById('dist-c-pct'),
            distDPct: document.getElementById('dist-d-pct')
        };

        function getAnswerTimeSeconds(answer) {
            try {
                if (!answer) return null;
                if (typeof answer.answerTime === 'number' && isFinite(answer.answerTime)) return answer.answerTime;
                if (typeof answer.time === 'number' && isFinite(answer.time)) return answer.time;
                if (typeof answer.answerTime === 'string' && answer.answerTime.trim() !== '') {
                    var t = parseFloat(answer.answerTime);
                    if (isFinite(t)) return t;
                }
                // ÿßÿ¥ÿ™ŸÇÿßŸÇ ÿßŸÑÿ≤ŸÖŸÜ ŸÖŸÜ timestamp Ÿà questionStartTime ÿ•ÿ∞ÿß ŸÖÿ™ÿßÿ≠
                var ts = (typeof answer.timestamp === 'number') ? answer.timestamp : parseInt(answer.timestamp, 10);
                var startRaw = localStorage.getItem('questionStartTime');
                var start = startRaw ? parseInt(startRaw, 10) : NaN;
                if (isFinite(ts) && isFinite(start)) {
                    var sec = Math.max(0, Math.round(((ts - start) / 1000) * 10) / 10);
                    return sec;
                }
            } catch (e) {}
            return null;
        }

        function updateTopBar() {
            if (elements.topQuestion) {
                elements.topQuestion.textContent = String(monitorState.currentQuestion + 1);
            }
        }

        function updateKPIsAndSummary() {
            try {
                updateTopBar();
                var connected = (monitorState.connectedTeamIds && monitorState.connectedTeamIds.length)
                    ? monitorState.connectedTeamIds.length
                    : (monitorState.teams ? monitorState.teams.length : 0);

                // ÿ£ÿ¨Ÿàÿ®ÿ© ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸÇÿ∑
                var answers = (monitorState.answers || []).filter(function(a) {
                    if (!a) return false;
                    var qIdx = (typeof a.questionIndex === 'number') ? a.questionIndex : parseInt(a.questionIndex, 10);
                    return qIdx === monitorState.currentQuestion;
                });

                // unique by teamId
                var seen = {};
                var uniqueAnswers = [];
                for (var i = 0; i < answers.length; i++) {
                    var a = answers[i];
                    var key = a && a.teamId !== undefined && a.teamId !== null ? String(a.teamId) : '';
                    if (!key || seen[key]) continue;
                    seen[key] = true;
                    uniqueAnswers.push(a);
                }

                var answeredCount = uniqueAnswers.length;

                var question = monitorState.questions && monitorState.questions[monitorState.currentQuestion]
                    ? monitorState.questions[monitorState.currentQuestion]
                    : null;
                var correctIndex = question ? question.answer : null;
                var correctLetter = (correctIndex === 0 || correctIndex === 1 || correctIndex === 2 || correctIndex === 3)
                    ? String.fromCharCode(65 + correctIndex)
                    : '‚Äî';

                var correctCount = 0;
                var dist = [0,0,0,0];
                var fastest = null;
                for (var j = 0; j < uniqueAnswers.length; j++) {
                    var ua = uniqueAnswers[j];
                    var opt = (typeof ua.selectedOption === 'number') ? ua.selectedOption : parseInt(ua.selectedOption, 10);
                    if (opt >= 0 && opt <= 3) dist[opt]++;
                    if (question && opt === correctIndex) correctCount++;
                    var sec = getAnswerTimeSeconds(ua);
                    if (sec !== null) {
                        if (!fastest || sec < fastest.sec) {
                            var t = monitorState.teams && monitorState.teams.find(function(x){ return x && String(x.id) === String(ua.teamId); });
                            fastest = { sec: sec, teamName: t ? (t.teamName || t.name || '') : '' };
                        }
                    }
                }

                if (elements.kpiConnected) elements.kpiConnected.textContent = String(connected);
                if (elements.kpiAnswered) elements.kpiAnswered.textContent = String(answeredCount);
                if (elements.kpiCorrect) elements.kpiCorrect.textContent = String(correctCount);
                if (elements.kpiAnsweredSub) elements.kpiAnsweredSub.textContent = 'ŸÖŸÜ ' + String(connected || 0);
                if (elements.kpiFastest) elements.kpiFastest.textContent = fastest && fastest.teamName ? fastest.teamName : '‚Äî';
                if (elements.kpiFastestSub) elements.kpiFastestSub.textContent = fastest ? (String(fastest.sec) + 'ÿ´') : '‚Äî';

                if (elements.correctAnswerPill) {
                    elements.correctAnswerPill.textContent = 'ÿßŸÑÿÆŸäÿßÿ± ÿßŸÑÿµÿ≠Ÿäÿ≠: ' + correctLetter;
                }

                var total = answeredCount || 0;
                function setBar(el, pctEl, count) {
                    var pct = total ? Math.round((count / total) * 100) : 0;
                    if (el) el.style.width = pct + '%';
                    if (pctEl) pctEl.textContent = pct + '%';
                }
                setBar(elements.distA, elements.distAPct, dist[0]);
                setBar(elements.distB, elements.distBPct, dist[1]);
                setBar(elements.distC, elements.distCPct, dist[2]);
                setBar(elements.distD, elements.distDPct, dist[3]);
            } catch (e) {}
        }

        // ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©
        function initMonitor() {
            console.log('ÿ™ŸáŸäÿ¶ÿ© ÿµŸÅÿ≠ÿ© ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ©...');

            try {
                if (typeof firebase !== 'undefined' && firebase.database) {
                    firebase.database().ref('.info/serverTimeOffset').on('value', function(snap) {
                        var off = snap && typeof snap.val === 'function' ? snap.val() : 0;
                        if (isFinite(off)) {
                            monitorState.serverTimeOffset = off;
                            monitorState.serverOffsetReady = true;
                        }
                    });
                }
            } catch (e) {}
            
            loadRoomData();
            loadQuestions();
            loadTeams();
            
            // ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
            setupEventListeners();
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ®ÿØÿ° ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            const urlParams = new URLSearchParams(window.location.search);
            const autoStart = urlParams.get('autoStart');
            
            console.log('autoStart:', autoStart);
            console.log('ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ≠ÿßŸÑŸäÿ© ÿπŸÜÿØ ÿßŸÑÿ™ŸáŸäÿ¶ÿ©:');
            console.log('- gameStarted:', localStorage.getItem('gameStarted'));
            console.log('- gameInProgress:', localStorage.getItem('gameInProgress'));
            console.log('- currentQuestionIndex:', localStorage.getItem('currentQuestionIndex'));
            
            // ŸÑÿß ÿ™ÿ∫Ÿäÿ± ÿßŸÑŸÇŸäŸÖ ÿßŸÑÿ≠ÿßŸÑŸäÿ© - ÿØÿπŸáÿß ŸÉŸÖÿß ŸáŸä
            // ŸÅŸÇÿ∑ ÿ•ÿ∞ÿß ŸÑŸÖ ÿ™ŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿ©ÿå ÿßÿ∂ÿ®ÿ∑Ÿáÿß ÿ•ŸÑŸâ false
            if (localStorage.getItem('gameStarted') === null) {
                localStorage.setItem('gameStarted', 'false');
            }
            if (localStorage.getItem('gameInProgress') === null) {
                localStorage.setItem('gameInProgress', 'false');
            }
            
            console.log('ÿ®ÿπÿØ ÿßŸÑÿ™ÿπÿØŸäŸÑ:');
            console.log('- gameStarted:', localStorage.getItem('gameStarted'));
            console.log('- gameInProgress:', localStorage.getItem('gameInProgress'));
            console.log('- currentQuestionIndex:', localStorage.getItem('currentQuestionIndex'));
            
            if (autoStart === 'true') {
                console.log('ÿ®ÿØÿ° ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÖŸÅÿπŸÑ!');
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ•ŸÑŸâ 0
                monitorState.currentQuestion = 0;
                localStorage.setItem('currentQuestionIndex', '0');
                localStorage.setItem('questionStartTime', serverNow().toString());
                startGame();
                if (elements.startGameBtn) {
                    elements.startGameBtn.disabled = true;
                    elements.startGameBtn.textContent = 'ÿßŸÑŸÑÿπÿ®ÿ© ÿ®ÿØÿ£ÿ™';
                }
                showNotification('ÿ®ÿØÿ£ÿ™ ÿßŸÑŸÑÿπÿ®ÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã! ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ŸàŸÑ ŸÖÿπÿ±Ÿàÿ∂', 'success');
            } else {
                console.log('ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± - ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©" ŸÑŸÑÿ®ÿØÿ°');
                // ÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿßŸÜÿ™ÿ∏ÿßÿ±
                elements.questionText.textContent = 'ÿßÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©" ŸÑÿ®ÿØÿ° ÿßŸÑŸÖÿ≥ÿßÿ®ŸÇÿ©';
                // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ•ŸÑŸâ 0
                monitorState.currentQuestion = 0;
                console.log('ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© - ÿßŸÑŸÑÿπÿ®ÿ© ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±');
            }
        }
        
        // ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
        function setupEventListeners() {
            elements.startGameBtn.addEventListener('click', startGame);
            elements.nextQuestionBtn.addEventListener('click', nextQuestion);
            elements.showAnswerBtn.addEventListener('click', showAnswer);
            elements.endGameBtn.addEventListener('click', endGame);

            if (elements.copyRoomCodeBtn) {
                elements.copyRoomCodeBtn.addEventListener('click', function() {
                    var code = (elements.roomCodeDisplay && elements.roomCodeDisplay.textContent) ? elements.roomCodeDisplay.textContent.trim() : '';
                    if (!code) return;
                    try {
                        if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
                            navigator.clipboard.writeText(code);
                            showNotification('ÿ™ŸÖ ŸÜÿ≥ÿÆ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©', 'success');
                            return;
                        }
                    } catch (e) {}
                    try {
                        var ta = document.createElement('textarea');
                        ta.value = code;
                        document.body.appendChild(ta);
                        ta.select();
                        document.execCommand('copy');
                        ta.remove();
                        showNotification('ÿ™ŸÖ ŸÜÿ≥ÿÆ ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©', 'success');
                    } catch (e2) {}
                });
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ∫ÿ±ŸÅÿ©
        function loadRoomData() {
            var roomCode = localStorage.getItem('currentRoom');
            if (roomCode) {
                elements.roomCodeDisplay.textContent = roomCode;
                if (typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled()) {
                    FirebaseSync.onRoomUpdate(roomCode, function(data) {
                        if (data && data.teams) {
                            try {
                                monitorState.connectedTeamIds = Object.keys(data.teams);
                            } catch (e) {
                                monitorState.connectedTeamIds = [];
                            }
                        }
                        if (data && data.studentAnswers) {
                            var raw = data.studentAnswers;
                            var arr = Array.isArray(raw) ? raw : Object.keys(raw).map(function(k) { return raw[k]; });
                            localStorage.setItem('studentAnswers', JSON.stringify(arr));
                        }
                        // ÿπŸÜÿØ ÿßŸÜÿ™Ÿáÿßÿ° ŸàŸÇÿ™ ÿßŸÑÿ≥ÿ§ÿßŸÑ (ÿ£Ÿä ÿ∑ÿßŸÑÿ® Ÿäÿ±ÿ≥ŸÑ timeUp) ‚Üí ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸàÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä
                        if (data && data.timeUp && monitorState.gameActive && !monitorState.answerShownForCurrentQuestion) {
                            var qIndex = data.timeUp.questionIndex;
                            if (typeof qIndex === 'string') qIndex = parseInt(qIndex, 10);
                            if (qIndex === monitorState.currentQuestion) {
                                monitorState.answerShownForCurrentQuestion = true;
                                clearInterval(monitorState.timerInterval);
                                clearInterval(monitorState.answerMonitorInterval);
                                if (typeof FirebaseSync.clearTimeUpOnServer === 'function') {
                                    FirebaseSync.clearTimeUpOnServer(roomCode).then(function() {});
                                }
                                console.log('ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿ≥ÿ§ÿßŸÑ (ÿ•ÿ¥ÿßÿ±ÿ© ŸÖŸÜ ÿßŸÑÿ∑ÿßŸÑÿ®) - ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸàÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ');
                                showAnswer();
                                setTimeout(function() {
                                    nextQuestion();
                                }, 5000);
                            }
                        }
                    });
                }
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© (ŸÖŸÜ currentQuestions ÿ£Ÿà ÿßŸÑŸÜÿ≥ÿÆ ÿßŸÑÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿäÿ©)
        function loadQuestions() {
            var questionsData = localStorage.getItem('currentQuestions');
            if (questionsData) {
                try {
                    var parsed = JSON.parse(questionsData);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        monitorState.questions = parsed;
                        return;
                    }
                } catch (e) {}
            }
            var backupKeys = ['gameQuestions', 'selectedQuestions'];
            for (var i = 0; i < backupKeys.length; i++) {
                var raw = localStorage.getItem(backupKeys[i]);
                if (raw) {
                    try {
                        var arr = JSON.parse(raw);
                        if (Array.isArray(arr) && arr.length > 0) {
                            monitorState.questions = arr;
                            localStorage.setItem('currentQuestions', JSON.stringify(arr));
                            console.log('[ŸÖÿ±ÿßŸÇÿ®] ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÖŸÜ', backupKeys[i]);
                            return;
                        }
                    } catch (e) {}
                }
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅÿ±ŸÇ
        function loadTeams() {
            const teamsData = localStorage.getItem('gameTeams');
            if (teamsData) {
                monitorState.teams = JSON.parse(teamsData);
            }
            renderTeamsMonitor();
        }

        // ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≠ÿßŸÑŸä
        function displayQuestion() {
            if (monitorState.currentQuestion >= monitorState.questions.length) {
                endGame();
                return;
            }

            const question = monitorState.questions[monitorState.currentQuestion];
            
            elements.questionNumber.textContent = `ÿßŸÑÿ≥ÿ§ÿßŸÑ ${monitorState.currentQuestion + 1}`;
            elements.questionCategory.textContent = question.category;
            elements.questionText.textContent = question.question;
            
            // ÿπÿ±ÿ∂ ÿßŸÑÿÆŸäÿßÿ±ÿßÿ™ ŸÖÿπ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ÿ®ÿßŸÑŸÑŸàŸÜ ÿßŸÑÿ£ÿÆÿ∂ÿ± ŸÑŸÑŸÖÿπŸÑŸÖ ŸÅŸÇÿ∑
            elements.optionsPreview.innerHTML = question.options.map((option, index) => {
                const isCorrect = index === question.answer;
                const correctClass = isCorrect ? 'correct-answer' : '';
                const correctText = isCorrect ? ' ‚úì' : '';
                
                return `
                    <div class="option-preview ${correctClass}" data-index="${index}">
                        ${String.fromCharCode(65 + index)}. ${option}${correctText}
                    </div>
                `;
            }).join('');
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≠ÿßŸÑÿ©
            elements.nextQuestionBtn.disabled = true;
            elements.showAnswerBtn.disabled = false;
            
            // ŸÖÿ≥ÿ≠ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
            monitorState.answers = [];
            
            console.log('ÿ™ŸÖ ÿπÿ±ÿ∂ ÿßŸÑÿ≥ÿ§ÿßŸÑ:', monitorState.currentQuestion);
            console.log('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ŸÑŸÑÿ∑ŸÑÿßÿ®');
            
            renderTeamsMonitor();
            updateKPIsAndSummary();
        }

        // ÿπÿ±ÿ∂ ŸÖÿ±ÿßŸÇÿ®ÿ© ÿßŸÑŸÅÿ±ŸÇ
        function renderTeamsMonitor() {
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅÿ±ŸÇ ŸÖŸÜ localStorage ÿ£ŸàŸÑÿßŸã
            const teamsData = localStorage.getItem('gameTeams');
            if (teamsData) {
                const updatedTeams = JSON.parse(teamsData);
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÅŸä monitorState.teams
                updatedTeams.forEach(updatedTeam => {
                    const team = monitorState.teams.find(t => t.id === updatedTeam.id);
                    if (team) {
                        team.score = updatedTeam.score || 0;
                        team.bank = updatedTeam.bank || 0;
                    }
                });
            }
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸÇÿßÿ∑ (ŸÖŸÜ ÿßŸÑÿ£ÿπŸÑŸâ ŸÑŸÑÿ£ŸÇŸÑ)
            const sortedTeams = [...monitorState.teams].sort((a, b) => (b.score || 0) - (a.score || 0));
            
            elements.teamsMonitorContainer.innerHTML = sortedTeams.map((team, index) => {
                const answer = monitorState.answers.find(a => a.teamId === team.id && a.questionIndex === monitorState.currentQuestion);
                
                let statusClass = '';
                let statusText = '‚è≥ ŸÅŸä ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±';
                let answerInfo = '';
                
                if (answer) {
                    statusClass = 'answered';
                    const optionLetter = String.fromCharCode(65 + answer.selectedOption);
                    statusText = `‚úì ÿ£ÿ¨ÿßÿ®: ${optionLetter}`;
                    
                    // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©
                    const question = monitorState.questions[monitorState.currentQuestion];
                    if (question && answer.selectedOption === question.answer) {
                        statusClass = 'correct';
                        statusText = `‚úì ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©: ${optionLetter}`;
                        answerInfo = `<div class="selected-option" style="color: #4cc964; margin-top: 5px;">+${answer.pointsEarned || 0} ŸÜŸÇÿ∑ÿ©</div>`;
                    } else {
                        statusClass = 'wrong';
                        statusText = `‚úó ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©: ${optionLetter}`;
                        answerInfo = `<div class="selected-option" style="color: #ff6b6b; margin-top: 5px;">0 ŸÜŸÇÿ∑ÿ©</div>`;
                    }
                }

                var answerTime = getAnswerTimeSeconds(answer);
                var answerTimeText = (answerTime !== null) ? (String(answerTime) + 'ÿ´') : '‚Äî';
                var lastAnswerText = answer
                    ? (String.fromCharCode(65 + (answer.selectedOption || 0)))
                    : '‚Äî';
                var lastAnswerState = answer
                    ? (statusClass === 'correct' ? 'ÿµÿ≠Ÿäÿ≠' : statusClass === 'wrong' ? 'ÿÆÿ∑ÿ£' : 'ÿ£ÿ¨ÿßÿ®')
                    : 'ŸÑŸÖ Ÿäÿ¨ÿ®';
                
                // ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿ±ÿ™Ÿäÿ® ŸÑŸÑŸÅÿ±ŸäŸÇ
                const rankEmoji = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                const extraClass = index === 0 ? 'leader' : (index === sortedTeams.length - 1 ? 'last' : '');
                
                return `
                    <div class="team-answer-card ${statusClass} ${extraClass}" id="team-monitor-${team.id}">
                        <div class="team-row-grid">
                            <div>
                                <div class="team-info">
                                    <div>
                                        <span class="team-name">${rankEmoji} ${team.teamName}</span>
                                        ${answerInfo}
                                    </div>
                                    <div class="team-score" style="font-size: 1.2em; font-weight: bold;">
                                        ${team.score || 0} ŸÜŸÇÿ∑ÿ©
                                    </div>
                                </div>
                                <div class="answer-status">
                                    <span class="status-${statusClass === 'correct' ? 'correct' : statusClass === 'wrong' ? 'wrong' : statusClass === 'answered' ? 'answered' : 'waiting'}">
                                        ${statusText}
                                    </span>
                                </div>
                            </div>
                            <div class="meta">
                                <div class="meta-line">ÿ¢ÿÆÿ± ÿ•ÿ¨ÿßÿ®ÿ©: <strong>${lastAnswerText}</strong></div>
                                <div class="meta-line">ÿßŸÑÿ≠ÿßŸÑÿ©: <strong>${lastAnswerState}</strong></div>
                                <div class="meta-line">ÿßŸÑÿ≤ŸÖŸÜ: <strong>${answerTimeText}</strong></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            updateKPIsAndSummary();
        }
        
        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿ∑ŸÑÿßÿ®
        function checkStudentAnswers() {
            const studentAnswers = JSON.parse(localStorage.getItem('studentAnswers') || '[]');
            
            studentAnswers.forEach(answer => {
                // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿ¨ÿØŸäÿØÿ©
                if (!monitorState.answers.find(a => a.teamId === answer.teamId && a.timestamp === answer.timestamp)) {
                    monitorState.answers.push(answer);
                }
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÅÿ±ŸÇ ŸÖŸÜ localStorage
            const teamsData = localStorage.getItem('gameTeams');
            if (teamsData) {
                const updatedTeams = JSON.parse(teamsData);
                updatedTeams.forEach(updatedTeam => {
                    const team = monitorState.teams.find(t => t.id === updatedTeam.id);
                    if (team) {
                        team.score = updatedTeam.score || 0;
                        team.bank = updatedTeam.bank || 0;
                    }
                });
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
            renderTeamsMonitor();
        }

        // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ±ŸÇ
        function checkAllAnswers() {
            const totalTeams = monitorState.teams.length;
            const answeredTeams = monitorState.answers.length;
            
            if (answeredTeams >= totalTeams) {
                showNotification('ÿ£ÿ¨ÿßÿ®ÿ™ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ±ŸÇ!', 'success');
                elements.showAnswerBtn.disabled = false;
            }
        }

        // ŸÖÿ±ÿßŸÇÿ®ÿ© ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿ∑ŸÑÿßÿ® + ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØ ÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ¨ŸÖŸäÿπ
        function startAnswerMonitoring() {
            clearInterval(monitorState.answerMonitorInterval);
            monitorState.answerShownForCurrentQuestion = false;
            monitorState.answerMonitorInterval = setInterval(() => {
                const answersData = localStorage.getItem('studentAnswers');
                if (answersData) {
                    const answers = JSON.parse(answersData);
                    answers.forEach(answer => {
                        if (!monitorState.answers.find(a => a.teamId === answer.teamId && a.timestamp === answer.timestamp)) {
                            monitorState.answers.push(answer);
                        }
                    });
                    renderTeamsMonitor();
                }
                // ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ÿπŸÜÿØŸÖÿß Ÿäÿ¨Ÿäÿ® ŸÉŸÑ ÿßŸÑŸÅÿ±ŸÇ
                var teamCount = (monitorState.connectedTeamIds && monitorState.connectedTeamIds.length)
                    ? monitorState.connectedTeamIds.length
                    : ((monitorState.teams && monitorState.teams.length)
                        ? monitorState.teams.filter(function(t) { return t && t.id !== undefined && t.id !== null; }).length
                        : 0);
                if (teamCount > 0 && !monitorState.answerShownForCurrentQuestion) {
                    var answeredSet = {};
                    for (var i = 0; i < monitorState.answers.length; i++) {
                        var a = monitorState.answers[i];
                        if (!a) continue;
                        var qIdx = (typeof a.questionIndex === 'number') ? a.questionIndex : parseInt(a.questionIndex, 10);
                        if (qIdx !== monitorState.currentQuestion) continue;
                        if (a.teamId === undefined || a.teamId === null) continue;
                        answeredSet[String(a.teamId)] = true;
                    }
                    var answeredTeams = Object.keys(answeredSet).length;
                    if (answeredTeams >= teamCount) {
                        monitorState.answerShownForCurrentQuestion = true;
                        clearInterval(monitorState.timerInterval);
                        console.log('ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ±ŸÇ ÿ£ÿ¨ÿßÿ®ÿ™ - ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸàÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä');
                        showAnswer();
                        setTimeout(function() {
                            console.log('ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜŸç');
                            nextQuestion();
                        }, 5000);
                    }
                }
            }, 1000);
        }

        // ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©
        function showAnswer() {
            console.log('ÿßŸÑŸÖÿπŸÑŸÖ Ÿäÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ "ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©"');
            
            const question = monitorState.questions[monitorState.currentQuestion];
            
            // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑŸÖÿπŸÑŸÖ
            Array.from(elements.optionsPreview.children).forEach((opt, i) => {
                if (i === question.answer) {
                    opt.classList.add('correct');
                }
            });
            
            // ÿ•ÿπŸÑÿßŸÖ ÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿßÿ® ÿ®ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©
            localStorage.setItem('showCorrectAnswer', 'true');
            localStorage.setItem('correctAnswerIndex', question.answer);
            syncGameStateToFirebase();
            
            // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜŸÇÿßÿ∑ ŸÑŸÑŸÅÿ±ŸÇ ÿßŸÑÿ™Ÿä ÿ£ÿ¨ÿßÿ®ÿ™
            const answers = JSON.parse(localStorage.getItem('studentAnswers') || '[]');
            const currentQuestionAnswers = answers.filter(a => a.questionIndex === monitorState.currentQuestion);
            
            console.log('ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≠ÿßŸÑŸä:', currentQuestionAnswers);
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑ ŸÑŸÉŸÑ ŸÅÿ±ŸäŸÇ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
            currentQuestionAnswers.forEach(answer => {
                const team = monitorState.teams.find(t => t.id === answer.teamId);
                if (team) {
                    let points = answer.isCorrect ? 1 : 0;
                    if (points > 0) {
                        team.score = (team.score || 0) + points;
                        answer.pointsEarned = points;
                        console.log(`ÿßŸÑŸÅÿ±ŸäŸÇ ${team.teamName}: +${points} ŸÜŸÇÿ∑ÿ© (ÿ•ÿ¨ÿßÿ®ÿ© ÿµÿ≠Ÿäÿ≠ÿ©) - ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©: ${team.score}`);
                    } else {
                        answer.pointsEarned = 0;
                        console.log(`ÿßŸÑŸÅÿ±ŸäŸÇ ${team.teamName}: 0 ŸÜŸÇÿ∑ÿ© (ÿ•ÿ¨ÿßÿ®ÿ© ÿÆÿßÿ∑ÿ¶ÿ©/ŸÑŸÖ Ÿäÿ¨ÿ®) - ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©: ${team.score || 0}`);
                    }
                }
            });
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÅÿ±ŸÇ
            monitorState.teams.sort((a, b) => (b.score || 0) - (a.score || 0));
            
            // ÿ™ÿ≠ÿØŸäÿ´ localStorage
            localStorage.setItem('gameTeams', JSON.stringify(monitorState.teams));
            var roomCode = localStorage.getItem('currentRoom');
            if (typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled() && roomCode) {
                FirebaseSync.setGameTeamsOnServer(roomCode, monitorState.teams).then(function() {});
            }
            elements.showAnswerBtn.disabled = true;
            elements.nextQuestionBtn.disabled = false;
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑŸÅÿ±ŸÇ ŸÖÿπ ÿ•ÿ∏Ÿáÿßÿ± ÿßŸÑŸÜŸÇÿßÿ∑ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            renderTeamsMonitor();
            
            // ÿ•ÿ∏Ÿáÿßÿ± ÿ•ÿ¥ÿπÿßÿ± ÿ®ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
            const correctAnswers = currentQuestionAnswers.filter(a => a.isCorrect);
            if (correctAnswers.length > 0) {
                const pointsSummary = correctAnswers.map(a => {
                    const team = monitorState.teams.find(t => t.id === a.teamId);
                    return `${team.teamName}: +1`;
                }).join(' | ');
                showNotification(`ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÜŸÇÿßÿ∑: ${pointsSummary}`, 'success');
            }
        }
        
        // ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÜŸÇÿßÿ∑ ÿ≠ÿ≥ÿ® ÿßŸÑŸàŸÇÿ™ (ÿßŸÑŸÜÿ∏ÿßŸÖ ÿßŸÑÿ¨ÿØŸäÿØ)
        function calculatePoints(answerTime, isCorrect) {
            return isCorrect ? 1 : 0;
        }

        // ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©
        function startGame() {
            console.log('ÿßŸÑŸÖÿπŸÑŸÖ Ÿäÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ©...');
            
            monitorState.gameActive = true;
            
            // ÿ™ÿπÿ∑ŸäŸÑ ÿ≤ÿ± ÿßŸÑÿ®ÿØÿ° Ÿàÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ£ÿÆÿ±Ÿâ
            elements.startGameBtn.disabled = true;
            elements.startGameBtn.textContent = 'ÿßŸÑŸÑÿπÿ®ÿ© ÿ®ÿØÿ£ÿ™';
            
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿ•ŸÑŸâ 0
            monitorState.currentQuestion = 0;
            
            // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ© ŸÑŸÑÿ∑ŸÑÿßÿ® - ÿßŸÑÿ£ŸáŸÖ!
            console.log('ŸÇÿ®ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ©:');
            console.log('- gameStarted ÿßŸÑŸÇÿØŸäŸÖ:', localStorage.getItem('gameStarted'));
            console.log('- gameInProgress ÿßŸÑŸÇÿØŸäŸÖ:', localStorage.getItem('gameInProgress'));
            console.log('- currentQuestionIndex ÿßŸÑŸÇÿØŸäŸÖ:', localStorage.getItem('currentQuestionIndex'));
            
            localStorage.setItem('gameStarted', 'true');
            localStorage.setItem('gameInProgress', 'true');
            localStorage.setItem('currentQuestionIndex', '0');
            localStorage.setItem('questionStartTime', serverNow().toString());
            // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑÿ£ÿ≥ÿ¶ŸÑÿ© ŸÅŸä localStorage ÿ≠ÿ™Ÿâ Ÿäÿ±ÿßŸáÿß ÿßŸÑÿ∑ÿßŸÑÿ® (ŸÜŸÅÿ≥ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ£Ÿà ÿπÿ®ÿ± Firebase)
            if (monitorState.questions && monitorState.questions.length > 0) {
                localStorage.setItem('currentQuestions', JSON.stringify(monitorState.questions));
                localStorage.setItem('gameQuestions', JSON.stringify(monitorState.questions));
            }
            syncGameStateToFirebase(true);

            var roomCodeForSync = (localStorage.getItem('currentRoom') || localStorage.getItem('roomCode') || '').trim();
            if (roomCodeForSync && typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled && FirebaseSync.isEnabled()) {
                console.log('[ŸÖÿ±ÿßŸÇÿ®] ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ÿ®ÿØÿ° ÿßŸÑŸÑÿπÿ®ÿ© ŸÑŸÑÿ∑ŸÑÿßÿ® ‚Äî ŸÉŸàÿØ ÿßŸÑÿ∫ÿ±ŸÅÿ©:', roomCodeForSync);
            }
            
            displayQuestion();
            startAnswerMonitoring();
            startUnifiedTimer();
            showNotification('ÿ®ÿØÿ£ÿ™ ÿßŸÑŸÑÿπÿ®ÿ©! ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ£ŸàŸÑ ŸÖÿπÿ±Ÿàÿ∂', 'success');
            
            setTimeout(function() { syncGameStateToFirebase(false); }, 800);
            setTimeout(function() { syncGameStateToFirebase(false); }, 2000);
        }

        // ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä
        function nextQuestion() {
            console.log('ÿßŸÑŸÖÿπŸÑŸÖ: ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä');
            monitorState.answerShownForCurrentQuestion = false;
            clearInterval(monitorState.answerMonitorInterval);
            monitorState.currentQuestion++;
            
            // ŸÖÿ≥ÿ≠ ÿ•ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
            localStorage.removeItem('showCorrectAnswer');
            localStorage.removeItem('correctAnswerIndex');
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ≠ÿßŸÑŸä ŸÅŸä localStorage
            localStorage.setItem('currentQuestionIndex', monitorState.currentQuestion.toString());
            localStorage.setItem('questionStartTime', serverNow().toString());
            syncGameStateToFirebase(true);
            
            if (monitorState.currentQuestion >= monitorState.questions.length) {
                endGame();
                return;
            }
            
            displayQuestion();
            startAnswerMonitoring();
            resetTimer();
            
            elements.showAnswerBtn.disabled = false;
            elements.nextQuestionBtn.disabled = true;
        }

        // ÿßŸÑŸÖÿ§ŸÇÿ™ ÿßŸÑŸÖŸàÿ≠ÿØ: ÿ®ÿπÿØ 30 ÿ´ÿßŸÜŸäÿ© ŸÜÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿ´ŸÖ ŸÜŸÜÿ™ŸÇŸÑ ŸÑŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä (setTimeout ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ÿ£ŸÉÿ´ÿ± ŸÖŸàÿ´ŸàŸÇŸäÿ© ŸÖŸÜ setInterval)
        function startUnifiedTimer() {
            if (!monitorState.serverOffsetReady) {
                setTimeout(startUnifiedTimer, 120);
                return;
            }
            if (monitorState.timerTimeout) clearTimeout(monitorState.timerTimeout);
            if (monitorState.timerInterval) clearInterval(monitorState.timerInterval);
            var questionStartTime = localStorage.getItem('questionStartTime');
            var startTime = questionStartTime ? parseInt(questionStartTime, 10) : serverNow();
            function doTimeUp() {
                if (monitorState.answerShownForCurrentQuestion) return;
                monitorState.answerShownForCurrentQuestion = true;
                if (monitorState.timerTimeout) clearTimeout(monitorState.timerTimeout);
                monitorState.timerTimeout = null;
                console.log('ÿßŸÜÿ™ŸáŸâ ŸàŸÇÿ™ ÿßŸÑÿ≥ÿ§ÿßŸÑ (30 ÿ´ÿßŸÜŸäÿ©) - ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿ´ŸÖ ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ');
                try { showAnswer(); } catch (e) { console.error('showAnswer:', e); }
                setTimeout(function() {
                    console.log('ÿßŸÑŸÖÿπŸÑŸÖ: ÿßŸÑÿßŸÜÿ™ŸÇÿßŸÑ ŸÑŸÑÿ≥ÿ§ÿßŸÑ ÿßŸÑÿ™ÿßŸÑŸä');
                    try { nextQuestion(); } catch (e) { console.error('nextQuestion:', e); }
                    syncGameStateToFirebase(true);
                    setTimeout(syncGameStateToFirebase, 400);
                    setTimeout(syncGameStateToFirebase, 1200);
                }, 5000);
            }
            monitorState.timerTimeout = setTimeout(doTimeUp, 30000);
            var updateDisplay = function() {
                var elapsed = Math.floor((serverNow() - startTime) / 1000);
                var remaining = Math.max(0, 30 - elapsed);
                monitorState.timer = remaining;
                if (elements.timer) elements.timer.textContent = remaining;
                if (remaining <= 0 || elapsed >= 30) {
                    clearInterval(monitorState.timerInterval);
                    doTimeUp();
                }
            };
            updateDisplay();
            monitorState.timerInterval = setInterval(updateDisplay, 1000);
        }

        // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÖÿ§ŸÇÿ™ (ŸÑŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ŸÅŸä nextQuestion)
        function resetTimer() {
            startUnifiedTimer();
        }

        // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÑŸÑÿ¨ŸÖŸäÿπ
        function showCorrectAnswer() {
            const question = monitorState.questions[monitorState.currentQuestion];
            const correctAnswer = question.answer;
            
            console.log('ÿßŸÑŸÖÿπŸÑŸÖ Ÿäÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©:', correctAnswer);
            console.log('ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ≥ÿ§ÿßŸÑ:', question);
            
            // ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸÑŸÑÿ∑ŸÑÿßÿ®
            localStorage.setItem('showCorrectAnswer', 'true');
            localStorage.setItem('correctAnswerIndex', correctAnswer.toString());
            syncGameStateToFirebase();
            
            console.log('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ•ÿ¥ÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸÑŸÑÿ∑ŸÑÿßÿ®:', {
                showCorrectAnswer: localStorage.getItem('showCorrectAnswer'),
                correctAnswerIndex: localStorage.getItem('correctAnswerIndex')
            });
            
            // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ© ŸÅŸä Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿπŸÑŸÖ - ÿ•ÿ∞ÿß ŸÉÿßŸÜ optionsContainer ŸÖŸàÿ¨ŸàÿØ
            if (elements.optionsContainer && elements.optionsContainer.children) {
                Array.from(elements.optionsContainer.children).forEach((opt, i) => {
                    if (i === correctAnswer) {
                        opt.style.background = 'rgba(76, 201, 115, 0.2)';
                        opt.style.borderColor = '#4cc964';
                    }
                });
            } else {
                console.log('optionsContainer ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ - ÿ™ÿÆÿ∑Ÿä ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ŸÅŸä Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿπŸÑŸÖ');
            }
            
            // ŸÖÿ≥ÿ≠ ÿ•ÿ¥ÿßÿ±ÿ© ÿ®ÿπÿØ 5 ÿ´ŸàÿßŸÜŸä
            setTimeout(() => {
                localStorage.setItem('showCorrectAnswer', 'false');
                localStorage.removeItem('correctAnswerIndex');
                console.log('ÿ™ŸÖ ŸÖÿ≥ÿ≠ ÿ•ÿ¥ÿßÿ±ÿ© ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©');
            }, 5000);
        }

        // ÿ•ŸÜŸáÿßÿ° ÿßŸÑŸÑÿπÿ®ÿ©
        function endGame() {
            clearInterval(monitorState.timerInterval);
            monitorState.gameActive = false;
            
            // ŸÖÿ≥ÿ≠ ÿ•ÿ¥ÿßÿ±ÿßÿ™ ÿßŸÑŸÑÿπÿ®ÿ©
            localStorage.removeItem('gameStarted');
            localStorage.removeItem('gameInProgress');
            localStorage.setItem('roomActive', 'true');
            
            // ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÅÿ±ŸÇ ÿ≠ÿ≥ÿ® ÿßŸÑŸÜŸÇÿßÿ∑
            monitorState.teams.sort((a, b) => b.score - a.score);

            saveResultsSession(JSON.parse(JSON.stringify(monitorState.teams || [])));
            
            // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
            showResults();
        }

        // ÿπÿ±ÿ∂ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
        function showResults() {
            const winner = monitorState.teams[0];
            
            const modal = document.createElement('div');
            modal.className = 'results-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 2000;
            `;
            
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, rgba(74, 44, 114, 0.2), rgba(60, 179, 113, 0.15)); border-radius: 25px; padding: 40px; max-width: 700px; text-align: center; border: 2px solid rgba(74, 44, 114, 0.4); backdrop-filter: blur(20px); box-shadow: 0 20px 60px rgba(74, 44, 114, 0.4);">
                    <div style="font-size: 3em; margin-bottom: 20px;">üèÜ</div>
                    <div style="font-size: 2.5em; background: linear-gradient(135deg, var(--navis-primary), var(--navis-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; margin-bottom: 15px;">${winner.teamName}</div>
                    <p style="font-size: 1.3em; color: rgba(255, 255, 255, 0.9); margin-bottom: 30px;">ÿßŸÑŸÅÿßÿ¶ÿ≤ ÿ®ŸÄ <span style="background: linear-gradient(135deg, var(--navis-secondary), var(--navis-dark-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; font-size: 1.2em;">${winner.score}</span> ŸÜŸÇÿ∑ÿ©</p>
                    <div style="margin: 30px 0;">
                        <h3 style="color: var(--navis-primary); margin-bottom: 20px; font-size: 1.5em;">üìä ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÅÿ±ŸÇ</h3>
                        ${monitorState.teams.map((team, index) => {
                            const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìå';
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; margin: 10px 0; background: linear-gradient(135deg, rgba(74, 44, 114, 0.15), rgba(60, 179, 113, 0.1)); border: 2px solid rgba(74, 44, 114, 0.3); border-radius: 15px; backdrop-filter: blur(10px);">
                                    <span style="font-size: 1.2em; font-weight: 600; color: white;">${medal} ${team.teamName}</span>
                                    <span style="background: linear-gradient(135deg, var(--navis-primary), var(--navis-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700; font-size: 1.3em;">${team.score || 0} ŸÜŸÇÿ∑ÿ©</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="closeWinnerModal()" style="background: linear-gradient(135deg, var(--navis-primary), var(--navis-dark-blue)); border: none; padding: 15px 30px; border-radius: 20px; color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ÿ•ÿ∫ŸÑÿßŸÇ</button>
                        <button onclick="closeAndReturnStudents()" style="background: linear-gradient(135deg, var(--navis-secondary), var(--navis-dark-green)); border: none; padding: 15px 30px; border-radius: 20px; color: white; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">ÿ•ÿ∫ŸÑÿßŸÇ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ∑ŸÑÿßÿ®</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸàÿØÿßŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨
        function closeWinnerModal() {
            const modal = document.querySelector('.results-modal');
            if (modal) modal.remove();
        }

        // ÿ•ÿ∫ŸÑÿßŸÇ ŸÖŸàÿØÿßŸÑ ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨ Ÿàÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ∑ŸÑÿßÿ® ŸÑŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿ£ÿµŸÑŸäÿ©
        function closeAndReturnStudents() {
            closeWinnerModal();
            // ÿ•ÿ¥ÿßÿ±ÿ© ŸÑŸÑÿ∑ŸÑÿßÿ® ÿ®ÿßŸÑÿπŸàÿØÿ© ŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±
            localStorage.setItem('gameEnded', 'true');
            localStorage.setItem('returnToWaiting', 'true');
            // ŸÖÿ≥ÿ≠ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ©
            localStorage.removeItem('gameStarted');
            localStorage.removeItem('gameInProgress');
            localStorage.removeItem('currentQuestionIndex');
            localStorage.removeItem('questionStartTime');
            localStorage.setItem('roomActive', 'true');
            showNotification('ÿ™ŸÖ ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ∑ŸÑÿßÿ® ŸÑÿ∫ÿ±ŸÅÿ© ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±', 'success');
        }

        // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ÿ®ÿØÿ° ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
        document.addEventListener('DOMContentLoaded', function() {
            initMonitor();
            
            // ŸÅÿµŸÑ ÿßŸÑŸÖÿ±ÿßŸÇÿ®ÿ© ÿπŸÜ ÿßŸÑÿπÿ±ÿ∂ ŸÑÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ŸÑŸÇÿ© ÿßŸÑŸÑÿßŸÜŸáÿßÿ¶Ÿäÿ©
            setInterval(() => {
                checkStudentAnswers();
            }, 1000); // ŸÉŸÑ ÿ´ÿßŸÜŸäÿ© ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÅÿπŸÑŸä
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿπÿ±ÿ∂ ÿßŸÑÿØÿ±ÿ¨ÿßÿ™ ÿ®ÿ¥ŸÉŸÑ ŸÖÿ≥ÿ™ŸÖÿ±
            setInterval(() => {
                if (monitorState.gameActive) {
                    renderTeamsMonitor();
                }
            }, 2000); // ŸÉŸÑ ÿ´ÿßŸÜŸäÿ™ŸäŸÜ ŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿπÿ±ÿ∂
        });
    </script>
</body>
</html>
