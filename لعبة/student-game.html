<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ® Ù„Ø¹Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ - ØµÙØ­Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="styles-common.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; margin: 0 auto; padding: var(--spacing-mobile); }
        @media (min-width: 769px) { .container { padding: var(--spacing-tablet); } }

        .team-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .team-name { font-size: 1.2em; color: var(--navis-primary); font-weight: bold; }
        .team-score { font-size: 1.2em; color: var(--navis-secondary); }

        .waiting-screen {
            text-align: center;
            padding: 40px;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .waiting-screen i {
            font-size: 4em;
            color: var(--navis-primary);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .question-section {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 25px;
            border: 1px solid var(--border-color);
            display: none;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            background: var(--navis-primary);
            color: var(--bg-dark-1);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .timer {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--science-red);
        }

        .question-text {
            font-size: 1.3em;
            margin-bottom: 30px;
            line-height: 1.5;
            color: #fff;
        }

        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .options-container {
                gap: 8px;
                margin-bottom: 12px;
            }
        }

        @media (max-width: 480px) {
            .options-container {
                grid-template-columns: 1fr;
                gap: 6px;
                margin-bottom: 10px;
            }
        }

        .option {
            background: var(--card-bg-2);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 15px;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            color: #fff;
        }

        @media (max-width: 768px) {
            .option {
                padding: 12px;
                margin: 6px 0;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .option {
                padding: 10px;
                margin: 4px 0;
                font-size: 12px;
            }
        }

        .option:hover {
            background: var(--card-bg);
            border-color: var(--navis-primary);
            transform: translateY(-2px);
        }

        .option.selected {
            background: var(--card-bg);
            border-color: var(--navis-primary);
        }

        .option.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--navis-primary), var(--navis-dark-blue));
            color: #fff;
            border: none;
            padding: 12px 25px;
            border-radius: var(--radius-lg);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .submit-btn {
                padding: 10px 20px;
                font-size: 14px;
                margin: 12px 0;
            }
        }

        @media (max-width: 480px) {
            .submit-btn {
                padding: 8px 15px;
                font-size: 13px;
                margin: 10px 0;
            }
        }

        .submit-btn:hover {
            box-shadow: var(--shadow-glow);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .answer-feedback {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: bold;
            display: none;
        }

        .answer-feedback.correct {
            background: rgba(60, 179, 113, 0.2);
            color: var(--navis-secondary);
            border: 1px solid var(--navis-secondary);
        }

        .answer-feedback.wrong {
            background: rgba(231, 76, 60, 0.2);
            color: var(--science-red);
            border: 1px solid var(--science-red);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @media (max-width: 768px) {
            .options-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Ø´Ø¹Ø§Ø± Ù†Ø§ÙØ³ ÙˆÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… -->
    <div class="logos-header">
        <div class="logo-container">
            <img src="Ù†Ø§ÙØ³.png" alt="Ø´Ø¹Ø§Ø± Ù†Ø§ÙØ³" class="logo-img">
            <div>
                <h3 class="logo-title">Ù…Ø¨Ø§Ø¯Ø±Ø© Ù†Ø§ÙØ³</h3>
                <p class="logo-subtitle">National Olympiad for Innovation & Science</p>
            </div>
        </div>
        <div class="logo-container">
            <div style="text-align: left;">
                <h3 class="logo-title">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</h3>
                <p class="logo-subtitle">Ministry of Education</p>
            </div>
            <img src="ÙˆØ²Ø§Ø±Ù‡ Ø§Ù„ØªØ¹Ù„ÙŠÙ….png" alt="Ø´Ø¹Ø§Ø± ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…" class="logo-img">
        </div>
    </div>

    <div class="container">
        <header class="header science-header">
            <h1>ğŸ® ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</h1>
            <div class="team-info">
                <div class="team-name">Ø§Ù„ÙØ±ÙŠÙ‚: <span id="team-name">----</span></div>
                <div class="team-score">Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="team-score">0</span></div>
            </div>
        </header>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
        <div class="waiting-screen" id="waiting-screen">
            <i class="fas fa-hourglass-half"></i>
            <h2>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©...</h2>
            <p>Ø³ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ù‚Ø±ÙŠØ¨Ø§Ù‹</p>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ -->
        <div class="question-section" id="question-section">
            <div class="question-header">
                <span class="question-number" id="question-number">Ø§Ù„Ø³Ø¤Ø§Ù„ 1</span>
                <div class="timer">â±ï¸ <span id="timer">30</span></div>
            </div>
            <div class="question-text" id="question-text">
                Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...
            </div>
            <div class="options-container" id="options-container">
                <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù‡Ù†Ø§ -->
            </div>
            <button class="submit-btn" id="submit-answer-btn" style="display: none;" disabled>
                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            </button>
            <div class="answer-feedback" id="answer-feedback"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-sync.js"></script>
    <script>
        window.firebaseRoomState = null;
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
        const studentState = {
            teamId: null,
            teamName: '',
            score: 0,
            currentQuestion: 0,
            questions: [],
            selectedOption: null,
            hasAnswered: false,
            gameActive: false,
            timeUpSentForQuestion: false,
            isSubmitting: false,
            answerElapsedMs: null,
            questionInterval: null,
            timerQuestionIndex: null,
            timerStartTime: null,
            serverTimeOffset: 0,
            serverOffsetReady: false,
            roomPollInterval: null
        };

        function serverNow() {
            return Date.now() + (Number(studentState.serverTimeOffset) || 0);
        }

        // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const elements = {
            teamName: document.getElementById('team-name'),
            teamScore: document.getElementById('team-score'),
            waitingScreen: document.getElementById('waiting-screen'),
            questionSection: document.getElementById('question-section'),
            questionNumber: document.getElementById('question-number'),
            timer: document.getElementById('timer'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            submitAnswerBtn: document.getElementById('submit-answer-btn'),
            answerFeedback: document.getElementById('answer-feedback')
        };

        function getGameState(key) {
            if (window.firebaseRoomState && window.firebaseRoomState[key] !== undefined && window.firebaseRoomState[key] !== null)
                return window.firebaseRoomState[key];
            return localStorage.getItem(key);
        }
        /** ØªØ­ÙˆÙŠÙ„ currentQuestions Ù…Ù† Firebase (Ù‚Ø¯ ØªÙƒÙˆÙ† ÙƒØ§Ø¦Ù†Ø§Ù‹) Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© */
        function questionsArrayFromData(q) {
            if (!q) return [];
            if (Array.isArray(q)) return q;
            if (typeof q === 'object' && q !== null)
                return Object.keys(q).sort(function(a, b) { return Number(a) - Number(b); }).map(function(k) { return q[k]; });
            return [];
        }
        function getGameStateNum(key) {
            var v = getGameState(key);
            if (v === undefined || v === null) return undefined;
            return typeof v === 'number' ? v : parseInt(v, 10);
        }

        // ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
        function initStudent() {
            loadTeamData();
            var roomCode = localStorage.getItem('roomCode') || localStorage.getItem('currentRoom');
            if (typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled() && roomCode) {
                try {
                    if (typeof firebase !== 'undefined' && firebase.database) {
                        firebase.database().ref('.info/serverTimeOffset').on('value', function(snap) {
                            var off = snap && typeof snap.val === 'function' ? snap.val() : 0;
                            if (isFinite(off)) {
                                studentState.serverTimeOffset = off;
                                studentState.serverOffsetReady = true;
                            }
                        });
                    }
                } catch (e) {}
                FirebaseSync.onRoomUpdate(roomCode, function(data) {
                    window.firebaseRoomState = data;
                    if (!data) return;
                    // Firebase Ù‚Ø¯ ÙŠØ®Ø²Ù‘Ù† Ø§Ù„Ù…ØµÙÙˆÙØ§Øª ÙƒÙƒØ§Ø¦Ù†Ø§Øª - ØªØ­ÙˆÙŠÙ„ currentQuestions Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
                    var questionsArr = questionsArrayFromData(data.currentQuestions);
                    if (questionsArr.length > 0 && window.firebaseRoomState) window.firebaseRoomState.currentQuestions = questionsArr;
                    if (data.gameStarted && data.gameInProgress && data.currentQuestionIndex !== undefined && data.currentQuestionIndex !== null) {
                        if (!studentState.gameActive && questionsArr.length > 0) {
                            checkGameStart();
                        } else if (studentState.gameActive) {
                            var idx = typeof data.currentQuestionIndex === 'number' ? data.currentQuestionIndex : parseInt(data.currentQuestionIndex, 10);
                            if (isNaN(idx)) idx = studentState.currentQuestion;
                            var qStartTime = data.questionStartTime;
                            var questionsOk = studentState.questions && (studentState.questions[idx] !== undefined || studentState.questions.length > idx);
                            if (idx !== studentState.currentQuestion && questionsOk) {
                                console.log('Ø§Ù„Ø·Ø§Ù„Ø¨: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Firebase Ø¥Ù„Ù‰', idx);
                                studentState.currentQuestion = idx;
                                studentState.timeUpSentForQuestion = false;
                                studentState.hasAnswered = false;
                                studentState.selectedOption = null;
                                studentState.isSubmitting = false;
                                localStorage.setItem('currentQuestionIndex', String(idx));
                                if (qStartTime) {
                                    localStorage.setItem('questionStartTime', String(qStartTime));
                                }
                                if (typeof displayQuestion === 'function') displayQuestion();
                                if (typeof startTimer === 'function') startTimer();
                            } else if (qStartTime && localStorage.getItem('questionStartTime') !== String(qStartTime)) {
                                // Ù„Ø§ ØªØ¹ÙŠØ¯ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù†ÙØ³ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø³Ø¨Ø¨ ØªØ­Ø¯ÙŠØ«Ø§Øª Firebase Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
                                localStorage.setItem('questionStartTime', String(qStartTime));
                                var timerRunning = !!studentState.timerInterval;
                                var timerForThisQuestion = studentState.timerQuestionIndex === studentState.currentQuestion;
                                if (!timerRunning || !timerForThisQuestion) {
                                    if (typeof startTimer === 'function') startTimer();
                                }
                            }
                            if (data.gameTeams) {
                                var teams = Array.isArray(data.gameTeams) ? data.gameTeams : Object.values(data.gameTeams);
                                var fbTeam = teams.find(function(t) { return t && t.id === studentState.teamId; });
                                if (fbTeam && fbTeam.score !== undefined) {
                                    var teamScore = fbTeam.score || 0;
                                    if (teamScore !== studentState.score) {
                                        studentState.score = teamScore;
                                        elements.teamScore.textContent = teamScore;
                                    }
                                }
                            }
                            if (data.showCorrectAnswer === true && typeof showCorrectAnswer === 'function') showCorrectAnswer();
                        }
                    }
                });
            }
            checkGameStart();
            startQuestionMonitoring();
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚
        function loadTeamData() {
            const teamData = localStorage.getItem('currentTeam');
            if (teamData) {
                const team = JSON.parse(teamData);
                studentState.teamId = team.id;
                studentState.teamName = team.teamName;
                studentState.score = team.score || 0;
                
                elements.teamName.textContent = studentState.teamName;
                elements.teamScore.textContent = studentState.score;
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ±ÙŠÙ‚ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                window.location.href = 'student.html';
            }
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function checkGameStart() {
            var gameStarted = getGameState('gameStarted');
            var gameInProgress = getGameState('gameInProgress');
            var currentQuestionIndex = getGameState('currentQuestionIndex');
            if (typeof gameStarted === 'boolean') gameStarted = gameStarted ? 'true' : 'false';
            if (typeof gameInProgress === 'boolean') gameInProgress = gameInProgress ? 'true' : 'false';
            if (typeof currentQuestionIndex === 'number') currentQuestionIndex = String(currentQuestionIndex);
            console.log('Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©:', { gameStarted, gameInProgress, currentQuestionIndex });
            if (gameStarted === 'true' && gameInProgress === 'true' && currentQuestionIndex !== null && currentQuestionIndex !== undefined) {
                console.log('ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø³Ø¤Ø§Ù„!');
                console.log('Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', { gameStarted, gameInProgress, currentQuestionIndex });
                
                // Ù„Ø§ ØªØ¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ - Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…Ø¹Ù„Ù… ÙŠØ¶ØºØ· Ø¹Ù„Ù‰ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
                if (!studentState.gameActive) {
                    console.log('Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø·Ø§Ù„Ø¨...');
                    startGame();
                }
            } else {
                console.log('Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ØŒ Ø§Ù„Ø¨Ù‚Ø§Ø¡ ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
                elements.questionText.textContent = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…...';
                elements.optionsContainer.innerHTML = '';
                elements.timer.textContent = '--';
            }
        }
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function startGame() {
            console.log('Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø·Ø§Ù„Ø¨...');
            var foundQuestions = null;
            var sourceName = '';
            if (window.firebaseRoomState && window.firebaseRoomState.currentQuestions) {
                var q = window.firebaseRoomState.currentQuestions;
                var qArr = Array.isArray(q) ? q : (typeof q === 'object' && q !== null ? Object.keys(q).sort(function(a,b) { return Number(a)-Number(b); }).map(function(k) { return q[k]; }) : []);
                if (qArr.length > 0) { foundQuestions = qArr; sourceName = 'Firebase'; }
            }
            if (!foundQuestions) {
                var sources = ['currentQuestions', 'gameQuestions', 'selectedQuestions'];
                for (var s = 0; s < sources.length; s++) {
                    var data = localStorage.getItem(sources[s]);
                    if (data) {
                        try {
                            var questions = JSON.parse(data);
                            if (questions && questions.length > 0) {
                                foundQuestions = questions;
                                sourceName = sources[s];
                                break;
                            }
                        } catch (e) { console.log('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ ' + sources[s], e); }
                    }
                }
            }
            if (!foundQuestions) {
                console.warn('Ù„Ù… ØªÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø¢Ù† - Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¨Ø¹Ø¯ 1.5 Ø«Ø§Ù†ÙŠØ©...');
                var retryOnce = setTimeout(function() {
                    var retryQuestions = null;
                    if (window.firebaseRoomState && window.firebaseRoomState.currentQuestions) {
                        var q = window.firebaseRoomState.currentQuestions;
                        var qArr = questionsArrayFromData(q);
                        if (qArr.length > 0) retryQuestions = qArr;
                    }
                    if (!retryQuestions) {
                        var srcs = ['currentQuestions', 'gameQuestions', 'selectedQuestions'];
                        for (var r = 0; r < srcs.length; r++) {
                            var d = localStorage.getItem(srcs[r]);
                            if (d) {
                                try {
                                    var parsed = JSON.parse(d);
                                    if (parsed && parsed.length > 0) { retryQuestions = parsed; break; }
                                } catch (e) {}
                            }
                        }
                    }
                    if (retryQuestions && retryQuestions.length > 0) {
                        console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
                        studentState.gameActive = true;
                        elements.waitingScreen.style.display = 'none';
                        elements.questionSection.style.display = 'block';
                        studentState.questions = retryQuestions;
                        var teamData = JSON.parse(localStorage.getItem('currentTeam') || '{}');
                        studentState.teamId = teamData.id;
                        studentState.teamName = teamData.teamName || '';
                        studentState.score = teamData.score || 0;
                        var idx = getGameStateNum('currentQuestionIndex');
                        if (idx !== undefined && !isNaN(idx)) studentState.currentQuestion = idx;
                        if (elements.teamName) elements.teamName.textContent = studentState.teamName;
                        if (elements.teamScore) elements.teamScore.textContent = studentState.score;
                        if (typeof startTimer === 'function') startTimer();
                        if (typeof startQuestionMonitoring === 'function') startQuestionMonitoring();
                        if (typeof displayQuestion === 'function') displayQuestion();
                        return;
                    }
                    console.error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø© Ø¨Ø¹Ø¯ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©');
                    var srcs = ['currentQuestions', 'gameQuestions', 'selectedQuestions'];
                    console.log('Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† localStorage:');
                    for (var i = 0; i < srcs.length; i++) {
                        var data = localStorage.getItem(srcs[i]);
                        console.log('- ' + srcs[i] + ':', data ? data.substring(0, 50) + '...' : 'null');
                    }
                    elements.waitingScreen.innerHTML = '<h2>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªØ§Ø­Ø©</h2><p>ÙŠØ±Ø¬Ù‰ Ø¥Ø¨Ù„Ø§Øº Ø§Ù„Ù…Ø¹Ù„Ù… Ø¨ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©.</p><button class="btn btn-primary" onclick="location.reload()"><i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>';
                }, 1500);
                return;
            }
            
            console.log(`ÙˆØ¬Ø¯Øª ${foundQuestions.length} Ø³Ø¤Ø§Ù„ ÙÙŠ ${sourceName}`);
            
            var currentQuestionIndex = getGameState('currentQuestionIndex');
            if (currentQuestionIndex === null || currentQuestionIndex === undefined) {
                console.log('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ Ø­Ø§Ù„ÙŠØŒ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...');
                setTimeout(function() {
                    var newIndex = getGameState('currentQuestionIndex');
                    if (newIndex) {
                        studentState.currentQuestion = parseInt(newIndex);
                        console.log('ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¤Ø§Ù„:', studentState.currentQuestion);
                    }
                }, 1000);
            }
            
            studentState.gameActive = true;
            elements.waitingScreen.style.display = 'none';
            elements.questionSection.style.display = 'block';
            
            var teamData = JSON.parse(localStorage.getItem('currentTeam') || '{}');
            studentState.teamId = teamData.id;
            studentState.teamName = teamData.teamName;
            studentState.score = teamData.score || 0;
            if (window.firebaseRoomState && window.firebaseRoomState.gameTeams) {
                var teams = Array.isArray(window.firebaseRoomState.gameTeams) ? window.firebaseRoomState.gameTeams : Object.values(window.firebaseRoomState.gameTeams);
                var fbTeam = teams.find(function(t) { return t.id === studentState.teamId; });
                if (fbTeam && fbTeam.score !== undefined) studentState.score = fbTeam.score;
            }
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚:', teamData);
            studentState.questions = foundQuestions;
            var idx = getGameStateNum('currentQuestionIndex');
            if (idx !== undefined && !isNaN(idx)) studentState.currentQuestion = idx;
            console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„', studentState.questions.length, 'Ø³Ø¤Ø§Ù„');
            elements.teamName.textContent = studentState.teamName;
            elements.teamScore.textContent = studentState.score;
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª
            startTimer();
            
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
            startQuestionMonitoring();
            
            // Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¯ÙˆØ±ÙŠ Ù…Ù† Firebase ÙƒÙ„ 2 Ø«Ø§Ù†ÙŠØ© (Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ùˆ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙØ§ØªÙ‡ ØªØ­Ø¯ÙŠØ«)
            var roomCode = localStorage.getItem('roomCode') || localStorage.getItem('currentRoom');
            if (studentState.roomPollInterval) clearInterval(studentState.roomPollInterval);
            if (typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled() && roomCode && typeof FirebaseSync.getRoomFromServer === 'function') {
                studentState.roomPollInterval = setInterval(function() {
                    if (!studentState.gameActive) return;
                    FirebaseSync.getRoomFromServer(roomCode).then(function(data) {
                        if (!data || data.currentQuestionIndex === undefined) return;
                        var idx = typeof data.currentQuestionIndex === 'number' ? data.currentQuestionIndex : parseInt(data.currentQuestionIndex, 10);
                        if (isNaN(idx) || idx === studentState.currentQuestion) return;
                        if (!studentState.questions || idx >= studentState.questions.length) return;
                        console.log('Ø§Ù„Ø·Ø§Ù„Ø¨: ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø¥Ù„Ù‰', idx);
                        studentState.currentQuestion = idx;
                        studentState.timeUpSentForQuestion = false;
                        studentState.hasAnswered = false;
                        studentState.selectedOption = null;
                        window.firebaseRoomState = data;
                        localStorage.setItem('currentQuestionIndex', String(idx));
                        if (data.questionStartTime) localStorage.setItem('questionStartTime', String(data.questionStartTime));
                        if (typeof displayQuestion === 'function') displayQuestion();
                        if (typeof startTimer === 'function') startTimer();
                    });
                }, 2000);
            }
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function startGameMonitor() {
            console.log('Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø·Ø§Ù„Ø¨...');
            
            var checkInterval;
            function doCheck() {
                var gameStarted = localStorage.getItem('gameStarted');
                var gameInProgress = localStorage.getItem('gameInProgress');
                var currentQuestionIndex = localStorage.getItem('currentQuestionIndex');
                if (gameStarted === 'true' && gameInProgress === 'true' && currentQuestionIndex !== null && currentQuestionIndex !== '') {
                    console.log('ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙÙŠ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©');
                    clearInterval(checkInterval);
                    if (typeof checkGameStart === 'function') checkGameStart();
                }
            }
            doCheck();
            checkInterval = setInterval(doCheck, 1000);
        }
        
        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ
        function startQuestionMonitoring() {
            console.log('Ø¨Ø¯Ø¡ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ...');
            console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', studentState.questions.length);

            if (studentState.questionInterval) {
                clearInterval(studentState.questionInterval);
                studentState.questionInterval = null;
            }

            function canRenderQuestion() {
                return !!studentState.gameActive && Array.isArray(studentState.questions) && studentState.questions.length > 0;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø³Ø¤Ø§Ù„
            const currentQuestionIndex = localStorage.getItem('currentQuestionIndex');
            console.log('ÙØ­Øµ Ø£ÙˆÙ„ÙŠ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ:', currentQuestionIndex);
            
            if (currentQuestionIndex !== null && canRenderQuestion()) {
                const questionNum = parseInt(currentQuestionIndex);
                if (questionNum >= 0 && questionNum < studentState.questions.length) {
                    console.log('ÙˆØ¬Ø¯ Ø³Ø¤Ø§Ù„ ÙÙˆØ±ÙŠØŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰:', questionNum);
                    studentState.currentQuestion = questionNum;
                    studentState.timeUpSentForQuestion = false;
                    displayQuestion();
                    startTimer();
                }
            }
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª - Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªÙƒØ±Ø§Ø±
            let lastQuestionIndex = currentQuestionIndex;
            
            studentState.questionInterval = setInterval(() => {
                let currentIndex = getGameState('currentQuestionIndex');
                if (typeof currentIndex === 'number') currentIndex = String(currentIndex);

                if (!canRenderQuestion()) return;
                
                // ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„
                if (currentIndex !== lastQuestionIndex && currentIndex !== null) {
                    console.log('ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù†', lastQuestionIndex, 'Ø¥Ù„Ù‰', currentIndex);
                    lastQuestionIndex = currentIndex;
                    
                    const questionNum = parseInt(currentIndex, 10);
                    if (!isNaN(questionNum) && questionNum >= 0 && questionNum < studentState.questions.length) {
                        studentState.currentQuestion = questionNum;
                        studentState.timeUpSentForQuestion = false;
                        studentState.hasAnswered = false;
                        studentState.isSubmitting = false;
                        studentState.answerElapsedMs = null;
                        if (typeof displayQuestion === 'function') displayQuestion();
                        if (typeof startTimer === 'function') startTimer();
                    }
                }
            }, 800);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„
        function displayQuestion() {
            console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„:', studentState.currentQuestion);
            console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:', studentState.questions.length);
            
            if (studentState.currentQuestion >= studentState.questions.length) {
                console.log('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
                endGame();
                return;
            }
            
            const question = studentState.questions[studentState.currentQuestion];
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„:', question);
            
            if (!question) {
                console.error('Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!');
                console.error('Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ø±Ø¶ Ø³Ø¤Ø§Ù„ Ø±Ù‚Ù…:', studentState.currentQuestion);
                console.error('Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©:', studentState.questions.length);
                return;
            }
            
            console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­:', question.question);
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
            elements.questionNumber.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${studentState.currentQuestion + 1}`;
            elements.questionText.textContent = question.question;
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            elements.optionsContainer.innerHTML = question.options.map((option, index) => `
                <div class="option" onclick="selectOption(${index})">
                    ${String.fromCharCode(65 + index)}. ${option}
                </div>
            `).join('');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
            studentState.selectedOption = null;
            studentState.hasAnswered = false;
            elements.submitAnswerBtn.disabled = true;
            elements.answerFeedback.style.display = 'none';
            
            // Ø¥Ø²Ø§Ù„Ø© ÙƒÙ„Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected', 'disabled');
                opt.style.background = '';
                opt.style.borderColor = '';
            });
            
            console.log('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­');
        }
        
        // Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        function nextQuestion() {
            console.log('Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ...');
            
            studentState.currentQuestion++;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
            if (studentState.currentQuestion >= studentState.questions.length) {
                console.log('Ø§Ù†ØªÙ‡Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
                endGame();
                return;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
            studentState.selectedOption = null;
            studentState.hasAnswered = false;
            elements.submitAnswerBtn.disabled = true;
            elements.answerFeedback.style.display = 'none';
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
            displayQuestion();
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
            startTimer();
        }
        
        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function endGame() {
            elements.questionSection.style.display = 'none';
            elements.waitingScreen.style.display = 'block';
            
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ localStorage
            saveStudentData();
            
            elements.waitingScreen.innerHTML = `
                <h2>ğŸŠ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!</h2>
                <p>Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø·Ùƒ: ${studentState.score}</p>
                <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ù…Ø´Ø§Ø±ÙƒØªÙƒ!</p>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="fas fa-redo"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                    </button>
                    <a href="results.html" class="btn btn-info" target="_blank">
                        ğŸ† Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </a>
                </div>
            `;
        }

        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
        function saveStudentData() {
            try {
                const studentData = {
                    name: localStorage.getItem('myName') || 'Ø·Ø§Ù„Ø¨',
                    team: localStorage.getItem('myTeamName') || 'ÙØ±ÙŠÙ‚',
                    score: studentState.score,
                    percentage: Math.round((studentState.score / studentState.totalQuestions) * 100),
                    rank: 0, // Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
                    correctAnswers: studentState.correctAnswers || 0,
                    totalQuestions: studentState.totalQuestions || 60,
                    timestamp: new Date().toISOString()
                };
                
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
                localStorage.setItem('myStudentData', JSON.stringify(studentData));
                
                // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ±Ù‚
                updateTeamData(studentData);
                
                console.log('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:', studentData);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:', error);
            }
        }

        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚
        function updateTeamData(studentData) {
            try {
                // Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                let teamsData = localStorage.getItem('teamsData');
                teamsData = teamsData ? JSON.parse(teamsData) : [];
                
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ÙØ±ÙŠÙ‚ Ø§Ù„Ø·Ø§Ù„Ø¨
                const teamIndex = teamsData.findIndex(team => team.name === studentData.team);
                
                if (teamIndex !== -1) {
                    // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
                    teamsData[teamIndex].score = studentData.score;
                    teamsData[teamIndex].percentage = studentData.percentage;
                    teamsData[teamIndex].correctAnswers = studentData.correctAnswers;
                } else {
                    // Ø¥Ø¶Ø§ÙØ© ÙØ±ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯
                    teamsData.push({
                        name: studentData.team,
                        score: studentData.score,
                        percentage: studentData.percentage,
                        correctAnswers: studentData.correctAnswers,
                        totalQuestions: studentData.totalQuestions,
                        leader: studentData.name,
                        timestamp: new Date().toISOString()
                    });
                }
                
                // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø©
                localStorage.setItem('teamsData', JSON.stringify(teamsData));
                console.log('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ù‚:', teamsData);
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚:', error);
            }
        }

        // Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø§Ø¨Ø©
        function selectOption(index) {
            if (studentState.hasAnswered || !studentState.gameActive) return;
            if (typeof studentState.timer === 'number' && studentState.timer <= 0) return;
            
            console.log('Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:', index);
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
            document.querySelectorAll('.option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
            const option = elements.optionsContainer.children[index];
            option.classList.add('selected');
            
            studentState.selectedOption = index;
            
            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙˆØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            console.log('Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...');
            submitAnswer();
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        function submitAnswer() {
            if (studentState.selectedOption === null || studentState.hasAnswered) return;

            if (studentState.isSubmitting) return;
            studentState.isSubmitting = true;
            
            studentState.hasAnswered = true;
            var now = serverNow();
            studentState.answerTime = now;
            studentState.answerElapsedMs = null;
            
            console.log('Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØ±Ø³Ù„ Ø¥Ø¬Ø§Ø¨Ø©:', studentState.selectedOption);
            
            var question = studentState.questions[studentState.currentQuestion];
            var qStartTime = getGameState('questionStartTime');
            var startTime = qStartTime ? (typeof qStartTime === 'number' ? qStartTime : parseInt(qStartTime, 10)) : now;
            if (!isFinite(startTime) || startTime <= 0 || startTime > now + 1000) startTime = now;
            studentState.answerElapsedMs = Math.max(0, now - startTime);
            var elapsedSeconds = Math.floor((now - startTime) / 1000);
            var answerData = {
                teamId: studentState.teamId,
                teamName: studentState.teamName,
                questionIndex: studentState.currentQuestion,
                selectedOption: studentState.selectedOption,
                isCorrect: studentState.selectedOption === question.answer,
                timestamp: new Date().toISOString(),
                answerTime: elapsedSeconds
            };
            
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:', answerData);
            
            var answers = JSON.parse(localStorage.getItem('studentAnswers') || '[]');
            answers.push(answerData);
            localStorage.setItem('studentAnswers', JSON.stringify(answers));
            var roomCode = localStorage.getItem('roomCode') || localStorage.getItem('currentRoom');
            if (typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled() && roomCode) {
                FirebaseSync.pushStudentAnswerOnServer(roomCode, answerData).then(function() {});
            }
            console.log('ØªÙ… Ø­ÙØ¸ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨:', answerData);
            
            // Ø¹Ø¯Ù… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© â€” Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ÙŠØ¨Ù‚Ù‰ ÙŠØ¹Ù…Ù„ Ø­ØªÙ‰ ÙŠÙ†ØªÙ‚Ù„ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ (Ø¨Ø¹Ø¯ Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¬Ù…ÙŠØ¹ Ø£Ùˆ Ø§Ù†ØªÙ‡Ø§Ø¡ 30 Ø«Ø§Ù†ÙŠØ©)
            // clearInterval(studentState.timerInterval); â€” Ù…Ø­Ø°ÙˆÙ Ø­ØªÙ‰ Ù„Ø§ ÙŠØªÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ Ù„Ù…Ù† Ø¬Ø§ÙˆØ¨ ÙÙ‚Ø·
            
            // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨
            showAnswerResult(answerData.isCorrect);
            
            // ØªØ¹Ø·ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
            elements.submitAnswerBtn.disabled = true;
            Array.from(elements.optionsContainer.children).forEach(opt => {
                opt.disabled = true;
            });
            
            // Ù„Ø§ Ù†Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ù…Ù† Ø¬Ù‡Ø© Ø§Ù„Ø·Ø§Ù„Ø¨Ø› Ø³ÙŠØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø³Ø¤Ø§Ù„
            // Ø¹Ù†Ø¯Ù…Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø¹Ù„Ù… currentQuestionIndex ÙÙŠ localStorage
        }
        
        // Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
        function showAnswerResult(isCorrect) {
            if (isCorrect) {
                elements.answerFeedback.textContent = `âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨ØªÙƒ! Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${studentState.score}`;
                elements.answerFeedback.className = 'answer-feedback correct';
            } else {
                elements.answerFeedback.textContent = `ğŸ“ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø¬Ø§Ø¨ØªÙƒ! Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${studentState.score}`;
                elements.answerFeedback.className = 'answer-feedback wrong';
            }
            elements.answerFeedback.style.display = 'block';
        }
        
        // Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…
        function waitForCorrectAnswer() {
            console.log('Ø¨Ø¯Ø¡ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…...');
            
            const checkInterval = setInterval(() => {
                var showAnswer = getGameState('showCorrectAnswer');
                var correctAnswer = getGameState('correctAnswerIndex');
                if (typeof showAnswer === 'boolean') showAnswer = showAnswer ? 'true' : 'false';
                
                console.log('ÙØ­Øµ Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:', { showAnswer, correctAnswer });
                
                if (showAnswer === 'true' && correctAnswer !== null && correctAnswer !== '-1' && correctAnswer !== '-1') {
                    clearInterval(checkInterval);
                    
                    console.log('Ø§Ù„Ù…Ø¹Ù„Ù… ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:', correctAnswer);
                    
                    // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
                    showCorrectAnswer();
                    
                    // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
                    setTimeout(() => {
                        console.log('Ø§Ù„Ø·Ø§Ù„Ø¨: Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ');
                        nextQuestion();
                    }, 5000);
                }
            }, 1000);
        }
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
        function showCorrectAnswer() {
            const question = studentState.questions[studentState.currentQuestion];
            const correctAnswer = question.answer;
            
            console.log('Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù„Ù„Ø·Ø§Ù„Ø¨:', correctAnswer);
            console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¤Ø§Ù„:', question);
            console.log('Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:', studentState.selectedOption);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·Ø§Ù„Ø¨
            Array.from(elements.optionsContainer.children).forEach((opt, i) => {
                if (i === correctAnswer) {
                    opt.classList.add('correct');
                    opt.style.background = 'rgba(76, 201, 115, 0.2)';
                    opt.style.borderColor = '#4cc964';
                } else if (i === studentState.selectedOption && i !== correctAnswer) {
                    opt.classList.add('wrong');
                    opt.style.background = 'rgba(255, 71, 87, 0.2)';
                    opt.style.borderColor = '#ff6b6b';
                }
                opt.classList.add('disabled');
            });
            
            // Ø¹Ø±Ø¶ Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            if (studentState.selectedOption !== null) {
                const isCorrect = studentState.selectedOption === correctAnswer;
                console.log('Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:', {
                    selected: studentState.selectedOption,
                    correct: correctAnswer,
                    isCorrect: isCorrect
                });

                const elapsedMs = (typeof studentState.answerElapsedMs === 'number')
                    ? studentState.answerElapsedMs
                    : 30000;
                const points = calculatePoints(elapsedMs, isCorrect);
                studentState.score += points;
                elements.teamScore.textContent = studentState.score;

                if (isCorrect) {
                    elements.answerFeedback.textContent = `âœ“ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! +${points} Ù†Ù‚Ø·Ø© | Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø¢Ù†: ${studentState.score}`;
                    elements.answerFeedback.className = 'answer-feedback correct';
                } else {
                    elements.answerFeedback.textContent = `âœ— Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©! 0 Ù†Ù‚Ø·Ø© | Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø¢Ù†: ${studentState.score}`;
                    elements.answerFeedback.className = 'answer-feedback wrong';
                }
            } else {
                elements.answerFeedback.textContent = `âœ— Ù„Ù… ÙŠØ¬Ø¨! 0 Ù†Ù‚Ø·Ø© | Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø¢Ù†: ${studentState.score}`;
                elements.answerFeedback.className = 'answer-feedback wrong';
            }
            
            // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
            const elapsedMsForPoints = (typeof studentState.answerElapsedMs === 'number') ? studentState.answerElapsedMs : 30000;
            const answerData = {
                teamId: studentState.teamId,
                questionIndex: studentState.currentQuestion,
                selectedOption: studentState.selectedOption,
                isCorrect: studentState.selectedOption === correctAnswer,
                points: studentState.selectedOption !== null ? calculatePoints(elapsedMsForPoints, studentState.selectedOption === correctAnswer) : 0,
                timestamp: new Date().toISOString()
            };
            
            const answers = JSON.parse(localStorage.getItem('studentAnswers') || '[]');
            answers.push(answerData);
            localStorage.setItem('studentAnswers', JSON.stringify(answers));
            
            console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©:', answerData);
        }

        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
        function nextQuestion() {
            studentState.currentQuestion++;
            studentState.timeUpSentForQuestion = false;
            
            if (studentState.currentQuestion >= studentState.questions.length) {
                endGame();
                return;
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø¤Ø§Ù„
            studentState.hasAnswered = false;
            studentState.selectedOption = null;
            studentState.answerTime = null;
            studentState.answerElapsedMs = null;
            studentState.isSubmitting = false;
            studentState.timerQuestionIndex = null;
            studentState.timerStartTime = null;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            elements.answerFeedback.style.display = 'none';
            elements.submitAnswerBtn.disabled = true;
            
            // Ù…Ø³Ø­ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
            Array.from(elements.optionsContainer.children).forEach(opt => {
                opt.style.background = '';
                opt.style.borderColor = '';
                opt.classList.remove('selected');
            });
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ
            displayQuestion();
            
            // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            startTimer();
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„Ø³Ø±Ø¹Ø©
        function calculatePoints(answerTime, isCorrect) {
            return isCorrect ? 1 : 0;
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¤Ù‚Øª Ø§Ù„Ù…ØªØ²Ø§Ù…Ù† (ÙŠØ³ØªØ®Ø¯Ù… questionStartTime Ù…Ù† Firebase)
        function startTimer() {
            var questionStartTime = getGameState('questionStartTime');
            var parsedStartTime = questionStartTime ? (typeof questionStartTime === 'number' ? questionStartTime : parseInt(questionStartTime, 10)) : NaN;
            var now = serverNow();
            var startTime = parsedStartTime;

            // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø¨Ù‚Ø§Ø¡ questionStartTime Ù‚Ø¯ÙŠÙ… ÙÙŠ localStorage Ù…Ù…Ø§ ÙŠØ¬Ø¹Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ 0 Ø£Ùˆ Ø¨Ø¶Ø¹ Ø«ÙˆØ§Ù†ÙŠ ÙÙ‚Ø·
            // Ø¥Ø°Ø§ ÙƒØ§Ù† ØºÙŠØ± ØµØ§Ù„Ø­/Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ/Ù‚Ø¯ÙŠÙ… Ø£ÙƒØ«Ø± Ù…Ù† 30 Ø«Ø§Ù†ÙŠØ© Ù†Ø¹ÙŠØ¯ Ø¶Ø¨Ø·Ù‡
            if (!isFinite(startTime) || startTime <= 0 || startTime > now + 1000 || (now - startTime) > 30000) {
                startTime = now;
                try {
                    localStorage.setItem('questionStartTime', String(startTime));
                } catch (e) {}
            }

            // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ø¹Ø¯Ø© Ù…Ø±Ø§Øª Ù„Ù†ÙØ³ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¨Ø³Ø¨Ø¨ ØªØ­Ø¯ÙŠØ«Ø§Øª Firebase
            if (studentState.timerQuestionIndex === studentState.currentQuestion && studentState.timerStartTime === startTime) {
                return;
            }

            if (studentState.timerInterval) clearInterval(studentState.timerInterval);

            studentState.timerQuestionIndex = studentState.currentQuestion;
            studentState.timerStartTime = startTime;

            var questionIndexAtStart = studentState.currentQuestion;

            var updateTimer = function() {
                if (!studentState.gameActive) return;
                if (studentState.currentQuestion !== questionIndexAtStart) return;

                var remainingMs = (startTime + 30000) - serverNow();
                if (!isFinite(remainingMs)) remainingMs = 0;
                if (remainingMs < 0) remainingMs = 0;

                var remainingSec = Math.ceil(remainingMs / 1000);
                if (remainingSec < 0) remainingSec = 0;
                if (remainingSec > 30) remainingSec = 30;

                studentState.timer = remainingSec;
                elements.timer.textContent = remainingSec;

                if (remainingSec <= 10) {
                    elements.timer.style.color = '#dc3545';
                    elements.timer.style.fontWeight = 'bold';
                } else if (remainingSec <= 20) {
                    elements.timer.style.color = '#ffc107';
                } else {
                    elements.timer.style.color = '#28a745';
                }

                if (remainingMs <= 0) {
                    clearInterval(studentState.timerInterval);

                    if (!studentState.hasAnswered && !studentState.isSubmitting) {
                        studentState.selectedOption = -1;
                        submitAnswer();
                    }

                    // Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ÙˆÙ‚Øª Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ (Ø­ØªÙ‰ Ù„Ùˆ ØªØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù… ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
                    if (!studentState.timeUpSentForQuestion) {
                        studentState.timeUpSentForQuestion = true;
                        var roomCode = localStorage.getItem('roomCode') || localStorage.getItem('currentRoom');
                        if (typeof FirebaseSync !== 'undefined' && FirebaseSync.setTimeUpOnServer && roomCode) {
                            FirebaseSync.setTimeUpOnServer(roomCode, studentState.currentQuestion).then(function() {});
                        }
                    }
                }
            };
            updateTimer();
            studentState.timerInterval = setInterval(updateTimer, 250);
        }

        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        function endGame() {
            clearInterval(studentState.timerInterval);
            if (studentState.questionInterval) { clearInterval(studentState.questionInterval); studentState.questionInterval = null; }
            if (studentState.roomPollInterval) { clearInterval(studentState.roomPollInterval); studentState.roomPollInterval = null; }
            studentState.gameActive = false;
            
            showNotification('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©!', 'info');
            
            // Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø«Ù… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            setTimeout(() => {
                window.location.href = 'student.html';
            }, 3000);
        }

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        function initStudent() {
            console.log('ØªÙ‡ÙŠØ¦Ø© ØµÙØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨...');
            
            console.log('Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©...');
            console.log('- gameStarted:', localStorage.getItem('gameStarted'));
            console.log('- gameInProgress:', localStorage.getItem('gameInProgress'));
            console.log('- currentQuestionIndex:', localStorage.getItem('currentQuestionIndex'));
            console.log('- currentQuestions:', localStorage.getItem('currentQuestions') ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±ÙŠÙ‚
            const teamData = JSON.parse(localStorage.getItem('currentTeam') || '{}');
            if (teamData.id) {
                studentState.teamId = teamData.id;
                studentState.teamName = teamData.teamName;
                studentState.score = teamData.score || 0;
                
                elements.teamName.textContent = studentState.teamName;
                elements.teamScore.textContent = studentState.score;
                
                // Ø¥Ø°Ø§ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª ÙØ¹Ù„Ø§Ù‹ (Ø¬Ø§Ø¡ Ù…Ù† student-waiting Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ù„Ù…)ØŒ Ø§Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙˆØ±Ø§Ù‹
                var gameStarted = localStorage.getItem('gameStarted') === 'true';
                var gameInProgress = localStorage.getItem('gameInProgress') === 'true';
                var currentQuestionIndex = localStorage.getItem('currentQuestionIndex');
                var hasQuestions = false;
                try {
                    var q = localStorage.getItem('currentQuestions') || localStorage.getItem('gameQuestions') || localStorage.getItem('selectedQuestions');
                    if (q) {
                        var arr = JSON.parse(q);
                        hasQuestions = Array.isArray(arr) && arr.length > 0;
                    }
                } catch (e) {}
                if (gameStarted && gameInProgress && currentQuestionIndex !== null && currentQuestionIndex !== '' && hasQuestions) {
                    console.log('Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹ - Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙˆØ±Ø§Ù‹');
                    var roomCode = (localStorage.getItem('roomCode') || localStorage.getItem('currentRoom') || '').trim();
                    if (roomCode && typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled && FirebaseSync.isEnabled()) {
                        FirebaseSync.onRoomUpdate(roomCode, function(data) {
                            if (data) {
                                window.firebaseRoomState = data;
                                var qArr = questionsArrayFromData(data.currentQuestions);
                                if (qArr.length > 0) window.firebaseRoomState.currentQuestions = qArr;
                            }
                        });
                    }
                    if (typeof checkGameStart === 'function') checkGameStart();
                    return;
                }
                
                // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù†ØªØ¸Ø§Ø±
                elements.questionText.textContent = 'ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…...';
                elements.optionsContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØ¨Ø¯Ø£ Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù„Ø¹Ø¨Ø©</div>';
                elements.timer.textContent = '--';
                elements.submitAnswerBtn.disabled = true;
                
                console.log('Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© - Ø§Ù†ØªØ¸Ø§Ø± Ø¥Ø´Ø§Ø±Ø© Ù…Ù† Ø§Ù„Ù…Ø¹Ù„Ù…');
                startGameMonitor();
                startQuestionMonitoring();
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ÙØ±ÙŠÙ‚ØŒ Ø§Ù†ØªÙ‚Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙØ±ÙŠÙ‚ØŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…');
                window.location.href = 'student.html';
            }
        }

        // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
        elements.submitAnswerBtn.addEventListener('click', submitAnswer);

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        document.addEventListener('DOMContentLoaded', function() {
            initStudent();
            
            // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØºØ±ÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
            setInterval(() => {
                if (localStorage.getItem('returnToWaiting') === 'true') {
                    showNotification('Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...', 'info');
                    setTimeout(() => {
                        window.location.href = 'student-waiting.html';
                    }, 1500);
                }
            }, 2000);
        });
    </script>
</body>
</html>
