<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ - Ù…Ø¨Ø§Ø¯Ø±Ø© Ù†Ø§ÙØ³</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles-common.css">
    <style>
        body {
            min-height: 100vh;
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at 20% 20%, color-mix(in srgb, var(--navis-primary) 20%, transparent) 0%, transparent 45%),
                        radial-gradient(circle at 80% 75%, color-mix(in srgb, var(--navis-secondary) 18%, transparent) 0%, transparent 50%),
                        linear-gradient(135deg, var(--bg-dark-1) 0%, var(--bg-dark-2) 55%, var(--bg-dark-3) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            font-family: 'Tajawal', sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, var(--navis-primary), var(--navis-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--navis-primary), var(--navis-dark-blue));
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(74, 44, 114, 0.4);
        }

        .comparison-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 40px 0;
            flex-wrap: wrap;
        }

        .comparison-controls label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 1.1em;
        }

        .comparison-controls select {
            background: #fff;
            border: 1px solid rgba(0, 0, 0, 0.2);
            color: #1a1a1a;
            padding: 12px 20px;
            border-radius: 12px;
            font-family: 'Tajawal', sans-serif;
            font-weight: 500;
            font-size: 1em;
        }

        .comparison-controls select option {
            background: #fff;
            color: #1a1a1a;
        }

        .comparison-controls select:focus {
            outline: none;
            border-color: var(--navis-primary);
            box-shadow: 0 0 15px rgba(74, 44, 114, 0.3);
        }

        .compare-btn {
            background: linear-gradient(135deg, var(--navis-secondary), var(--navis-dark-green));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1em;
        }

        .compare-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(60, 179, 113, 0.4);
        }

        .results-section {
            margin: 40px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            color: var(--text-secondary);
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .summary-value {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--navis-secondary);
            margin-bottom: 10px;
        }

        .change-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(74, 44, 114, 0.1));
            border: 1px solid rgba(74, 44, 114, 0.3);
        }

        .change-value {
            font-size: 2em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .change-indicator {
            font-size: 2.5em;
        }

        .change-card.positive .change-value {
            color: #28a745;
        }

        .change-card.negative .change-value {
            color: #dc3545;
        }

        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .team-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .team-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(74, 44, 114, 0.3);
        }

        .team-name {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .team-scores {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 15px;
        }

        .score-item {
            text-align: center;
            flex: 1;
            flex-direction: column;
        }

        .score-label {
            font-size: 0.9em;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--navis-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--navis-primary), var(--navis-secondary));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .team-difference {
            margin-top: 10px;
            padding: 8px 12px;
            background: rgba(74, 44, 114, 0.1);
            border-radius: 8px;
            font-weight: 600;
        }

        .difference-positive {
            color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .difference-negative {
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .difference-neutral {
            color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .team-table {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
        }

        .team-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .team-table th,
        .team-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .team-table th {
            background: rgba(74, 44, 114, 0.2);
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1em;
        }

        .team-table td {
            color: var(--text-secondary);
            font-size: 1em;
        }

        .improvement {
            color: #28a745;
            font-weight: 600;
        }

        .decline {
            color: #dc3545;
            font-weight: 600;
        }

        .neutral {
            color: #ffc107;
            font-weight: 600;
        }

        .comparison-hint {
            color: var(--text-secondary);
            text-align: center;
            padding: 20px;
        }

        .badge-perf {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .badge-excellent { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .badge-good { background: linear-gradient(135deg, #17a2b8, #138496); color: white; }
        .badge-average { background: linear-gradient(135deg, #ffc107, #e0a800); color: #333; }
        .badge-poor { background: linear-gradient(135deg, #dc3545, #c82333); color: white; }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .comparison-controls {
                flex-direction: column;
                gap: 15px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
        <div class="header">
            <h1>ğŸ“ˆ Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡</h1>
            <a href="results.html" class="back-btn">
                <i class="fas fa-arrow-right"></i>
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù†ØªØ§Ø¦Ø¬
            </a>
        </div>

        <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©: Ø§Ø®ØªØ± Ø¬Ù„Ø³ØªÙŠ Ù„Ø¹Ø¨ Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù…Ù…ØªØ§Ø² / Ø³ÙŠØ¦) -->
        <div class="comparison-controls">
            <label>Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰:</label>
            <select id="session1-select">
                <option value="">Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø©</option>
            </select>
            <span style="font-size: 1.5em; font-weight: 700; color: var(--text-secondary);">VS</span>
            <label>Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©:</label>
            <select id="session2-select">
                <option value="">Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø©</option>
            </select>
            <button class="compare-btn" id="compare-btn">Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡</button>
        </div>

        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø© -->
        <div class="results-section">
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>ğŸ† Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡ (Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)</h3>
                    <div class="summary-value" id="best-group">-</div>
                    <div class="summary-value" id="best-score">-</div>
                </div>
                <div class="summary-card">
                    <h3>ğŸ“‰ Ø£Ù‚Ù„ Ø£Ø¯Ø§Ø¡ (Ø§Ù„Ù„Ø¹Ø¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©)</h3>
                    <div class="summary-value" id="worst-group">-</div>
                    <div class="summary-value" id="worst-score">-</div>
                </div>
                <div class="summary-card change-card" id="overall-change-card">
                    <h3>Ø§Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ù†Ø³Ø¨Ø© â†’ Ù†Ø³Ø¨Ø©)</h3>
                    <div class="change-value" id="overall-change">-</div>
                    <div class="change-indicator" id="overall-indicator">â¡ï¸</div>
                </div>
            </div>
            
            <div class="team-grid" id="team-grid">
                <p class="comparison-hint">Ø§Ø®ØªØ± Ø¬Ù„Ø³ØªÙŠ Ù„Ø¹Ø¨ Ø«Ù… Ø§Ø¶ØºØ· "Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡" Ù„Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ù…Ù…ØªØ§Ø² / Ø¬ÙŠØ¯ / Ø³ÙŠØ¦).</p>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="firebase-sync.js"></script>
    <script>
        let sessionsHistory = [];

        function getResultsHistory() {
            try {
                const raw = localStorage.getItem('gameResultsHistory');
                if (!raw) return [];
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) { return []; }
        }

        async function getResultsHistoryUniversal() {
            const roomCode = localStorage.getItem('currentRoom') || localStorage.getItem('teacherRoomCode') || '';
            if (typeof FirebaseSync !== 'undefined' && FirebaseSync.isEnabled && FirebaseSync.isEnabled() && roomCode) {
                try {
                    if (FirebaseSync.getResultsHistoryFromServer) {
                        const serverHistory = await FirebaseSync.getResultsHistoryFromServer(roomCode, 50);
                        if (Array.isArray(serverHistory) && serverHistory.length) return serverHistory;
                    }
                } catch (e) {}
            }
            return getResultsHistory();
        }

        function formatSessionLabel(session) {
            const room = session && session.roomCode ? String(session.roomCode) : '----';
            const when = session && session.createdAt ? new Date(session.createdAt) : null;
            const whenText = when && !isNaN(when.getTime()) ? when.toLocaleString('ar-SA', { hour12: true }) : '';
            return 'Ù…Ø¬Ù…ÙˆØ¹Ø© ' + room + (whenText ? ' - ' + whenText : '');
        }

        function getBadge(percentage) {
            if (percentage >= 90) return { text: 'Ù…Ù…ØªØ§Ø²', class: 'badge-excellent' };
            if (percentage >= 75) return { text: 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹', class: 'badge-good' };
            if (percentage >= 60) return { text: 'Ø¬ÙŠØ¯', class: 'badge-average' };
            return { text: 'Ø³ÙŠØ¦', class: 'badge-poor' };
        }

        function teamPercentage(team, totalQuestions) {
            const total = Number(totalQuestions) || 0;
            const score = Number(team.score) || 0;
            if (total <= 0) return 0;
            const maxPossible = total * 3;
            return Math.min(100, Math.max(0, Math.round((score / maxPossible) * 100)));
        }

        async function setupSessionSelectors() {
            sessionsHistory = await getResultsHistoryUniversal();
            const sel1 = document.getElementById('session1-select');
            const sel2 = document.getElementById('session2-select');
            if (!sel1 || !sel2) return;

            const options = sessionsHistory.map(s => {
                const label = formatSessionLabel(s);
                return '<option value="' + (s.id || '') + '">' + label + '</option>';
            }).join('');

            sel1.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø©</option>' + options;
            sel2.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¬Ù„Ø³Ø©</option>' + options;
        }

        function comparePerformance() {
            const id1 = document.getElementById('session1-select').value;
            const id2 = document.getElementById('session2-select').value;
            const teamGrid = document.getElementById('team-grid');

            if (!id1 || !id2) {
                teamGrid.innerHTML = '<p class="comparison-hint">Ø§Ø®ØªØ± Ø¬Ù„Ø³ØªÙŠ Ù„Ø¹Ø¨ Ø«Ù… Ø§Ø¶ØºØ· "Ù‚Ø§Ø±Ù† Ø§Ù„Ø£Ø¯Ø§Ø¡".</p>';
                document.getElementById('best-group').textContent = '-';
                document.getElementById('best-score').textContent = '-';
                document.getElementById('worst-group').textContent = '-';
                document.getElementById('worst-score').textContent = '-';
                document.getElementById('overall-change').textContent = '-';
                document.getElementById('overall-indicator').textContent = 'â¡ï¸';
                return;
            }

            const s1 = sessionsHistory.find(s => s.id === id1);
            const s2 = sessionsHistory.find(s => s.id === id2);
            if (!s1 || !s2 || !s1.teams || !s2.teams) {
                alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³ØªÙŠÙ†');
                return;
            }

            const teams1 = Array.isArray(s1.teams) ? s1.teams : Object.values(s1.teams);
            const teams2 = Array.isArray(s2.teams) ? s2.teams : Object.values(s2.teams);
            const totalQ1 = Number(s1.totalQuestions) || 0;
            const totalQ2 = Number(s2.totalQuestions) || 0;

            const nameToTeam = (list, totalQ) => {
                const map = {};
                list.forEach(t => {
                    const name = (t.name || t.teamName || '').trim() || 'ÙØ±ÙŠÙ‚';
                    map[name] = { name, score: Number(t.score) || 0, pct: teamPercentage(t, totalQ) };
                });
                return map;
            };
            const map1 = nameToTeam(teams1, totalQ1);
            const map2 = nameToTeam(teams2, totalQ2);
            const allNames = new Set([...Object.keys(map1), ...Object.keys(map2)]);
            const comparisons = [];
            allNames.forEach(name => {
                const a = map1[name] || { name, score: 0, pct: 0 };
                const b = map2[name] || { name, score: 0, pct: 0 };
                const diffPct = b.pct - a.pct;
                const badge = getBadge(b.pct);
                comparisons.push({ name, score1: a.score, pct1: a.pct, score2: b.score, pct2: b.pct, diffPct, badge });
            });
            comparisons.sort((a, b) => b.pct2 - a.pct2);

            const best = comparisons[0];
            const worst = comparisons.length ? comparisons[comparisons.length - 1] : null;
            const avgPct1 = comparisons.length ? Math.round(comparisons.reduce((s, c) => s + c.pct1, 0) / comparisons.length) : 0;
            const avgPct2 = comparisons.length ? Math.round(comparisons.reduce((s, c) => s + c.pct2, 0) / comparisons.length) : 0;
            const overallChange = avgPct2 - avgPct1;

            document.getElementById('best-group').textContent = best ? best.name : '-';
            document.getElementById('best-score').textContent = best ? best.pct2 + '%' : '-';
            document.getElementById('worst-group').textContent = worst ? worst.name : '-';
            document.getElementById('worst-score').textContent = worst ? worst.pct2 + '%' : '-';
            document.getElementById('overall-change').textContent = (overallChange >= 0 ? '+' : '') + overallChange + '%';
            const changeCard = document.getElementById('overall-change-card');
            const changeIndicator = document.getElementById('overall-indicator');
            changeCard.classList.remove('positive', 'negative');
            if (overallChange > 0) { changeCard.classList.add('positive'); changeIndicator.textContent = 'ğŸ“ˆ'; }
            else if (overallChange < 0) { changeCard.classList.add('negative'); changeIndicator.textContent = 'ğŸ“‰'; }
            else changeIndicator.textContent = 'â¡ï¸';

            const label1 = formatSessionLabel(s1);
            const label2 = formatSessionLabel(s2);
            const cards = comparisons.map(c => {
                let diffClass = 'neutral';
                let diffText = 'Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙˆÙ‰';
                if (c.diffPct > 0) { diffClass = 'improvement'; diffText = '+' + c.diffPct + '% ØªØ­Ø³Ù†'; }
                else if (c.diffPct < 0) { diffClass = 'decline'; diffText = c.diffPct + '% ØªØ±Ø§Ø¬Ø¹'; }
                return `
                    <div class="team-card">
                        <div class="team-name">${c.name}</div>
                        <div class="team-scores">
                            <div class="score-item">
                                <span class="score-label">${label1}</span>
                                <div class="score-value">${c.score1} Ù† | ${c.pct1}%</div>
                            </div>
                            <div class="score-item">
                                <span class="score-label">${label2}</span>
                                <div class="score-value">${c.score2} Ù† | ${c.pct2}%</div>
                            </div>
                        </div>
                        <div class="team-difference">
                            <span class="difference-value ${diffClass}">${diffText}</span>
                            <span class="badge-perf ${c.badge.class}">${c.badge.text}</span>
                        </div>
                    </div>`;
            }).join('');
            teamGrid.innerHTML = cards;
        }

        document.addEventListener('DOMContentLoaded', function() {
            setupSessionSelectors();
            document.getElementById('compare-btn').addEventListener('click', comparePerformance);
            document.getElementById('session1-select').addEventListener('change', comparePerformance);
            document.getElementById('session2-select').addEventListener('change', comparePerformance);
        });
    </script>
</body>
</html>
